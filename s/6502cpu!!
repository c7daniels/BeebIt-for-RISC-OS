;>6502cpu!!.s
;
; BeebIt - BBC Micro Model B Emulator
;
; Cycle-level CPU emulation
;
; (C) Copyright Crispian Daniels, 2025
;
; Email: <convertedgames@3insdale.me.uk>
;

  GET h.6502zmaps

  GET h.6502cmaps

  GET h.6502cpus

; Use the GET directive to include register definitions as if typed here

  GET h.RegNames

; Area name C$$code advisable as wanted to link with C output

  AREA |C$$code|, CODE, READONLY

; Import global symbols

  IMPORT |logcycles|

  IMPORT |deferlogfetch|
  IMPORT |logfetch|

; Export global symbols

  EXPORT |r6502invokeaddressing|
  EXPORT |r6502cyclereadmappedreturn|
  EXPORT |r6502cyclereadspecialreturn|
  EXPORT |r6502cyclestretch1readspecialreturn|
  EXPORT |r6502cyclestretch2readspecialreturn|
  EXPORT |r6502cyclereadspecialpopreturn|
  EXPORT |r6502cyclestretch1readspecialpopreturn|
  EXPORT |r6502cyclestretch2readspecialpopreturn|
  EXPORT |r6502cyclediscardmappedreturn|
  EXPORT |r6502cyclediscardspecialreturn|
  EXPORT |r6502cyclestretch1discardspecialreturn|
  EXPORT |r6502cyclestretch2discardspecialreturn|
  EXPORT |r6502cyclediscardspecialpopreturn|
  EXPORT |r6502cyclestretch1discardspecialpopreturn|
  EXPORT |r6502cyclestretch2discardspecialpopreturn|
  EXPORT |r6502cyclewritemappedreturn|
  EXPORT |r6502cyclewritespecialreturn|
  EXPORT |r6502cyclestretch1writespecialreturn|
  EXPORT |r6502cyclestretch2writespecialreturn|
  EXPORT |r6502cyclewritespecialpopreturn|
  EXPORT |r6502cyclestretch1writespecialpopreturn|
  EXPORT |r6502cyclestretch2writespecialpopreturn|
  EXPORT |r6502completecyclefetchreturn|
  EXPORT |r6502cyclefetchmappedreturn|
  EXPORT |r6502cyclefetchspecialreturn|
  EXPORT |r6502cyclefetchafterreadspecial|
  EXPORT |r6502cyclestretch1fetchspecialreturn|
  EXPORT |r6502cyclestretch2fetchspecialreturn|
  EXPORT |r6502cyclefetchspecialpopreturn|
  EXPORT |r6502cyclestretch1fetchspecialpopreturn|
  EXPORT |r6502cyclestretch2fetchspecialpopreturn|
  EXPORT |r6502completecycleearlyinterruptfetchreturn|
  EXPORT |r6502cycleearlyinterruptfetchmappedreturn|
  EXPORT |r6502cycleearlyinterruptfetchspecialreturn|
  EXPORT |r6502cycleearlyinterruptfetchafterreadspecial|
  EXPORT |r6502cycleearlyinterruptstretch1fetchspecialreturn|
  EXPORT |r6502cycleearlyinterruptstretch2fetchspecialreturn|
  EXPORT |r6502cycleearlyinterruptfetchspecialpopreturn|
  EXPORT |r6502cycleearlyinterruptstretch1fetchspecialpopreturn|
  EXPORT |r6502cycleearlyinterruptstretch2fetchspecialpopreturn|
  EXPORT |r6502completecycleinterruptfetchreturn|
  EXPORT |r6502cycleinterruptfetchmappedreturn|
  EXPORT |r6502cycleinterruptfetchspecialreturn|
  EXPORT |r6502cycleinterruptfetchafterreadspecial|
  EXPORT |r6502cycleinterruptstretch1fetchspecialreturn|
  EXPORT |r6502cycleinterruptstretch2fetchspecialreturn|
  EXPORT |r6502cycleinterruptfetchspecialpopreturn|
  EXPORT |r6502cycleinterruptstretch1fetchspecialpopreturn|
  EXPORT |r6502cycleinterruptstretch2fetchspecialpopreturn|
  EXPORT |r6502toimmediatestep|
  EXPORT |r6502operandstep|
  EXPORT |r6502nopstep|
  EXPORT |r6502clcstep|
  EXPORT |r6502secstep|
  EXPORT |r6502clistep|
  EXPORT |r6502seistep|
  EXPORT |r6502cldstep|
  EXPORT |r6502sedstep|
  EXPORT |r6502clvstep|
  EXPORT |r6502taxstep|
  EXPORT |r6502taystep|
  EXPORT |r6502txastep|
  EXPORT |r6502txsstep|
  EXPORT |r6502tyastep|
  EXPORT |r6502tsxstep|
  EXPORT |r6502pulledastep|
  EXPORT |r6502pulledpstep|
  EXPORT |r6502hltstep|
  EXPORT |r6502beforepullstep|
  EXPORT |r6502topullstep|
  EXPORT |r6502breadcrumbloadzpgstep|
  EXPORT |r6502loadzpgstep|
  EXPORT |r6502breadcrumblatchabslostep|
  EXPORT |r6502latchabslostep|
  EXPORT |r6502breadcrumbloadabsstep|
  EXPORT |r6502loadabsstep|
  EXPORT |r6502breadcrumblatchzpgindlostep|
  EXPORT |r6502latchzpgindlostep|
  EXPORT |r6502breadcrumbloadzpgxstep|
  EXPORT |r6502loadzpgxstep|
  EXPORT |r6502loadzpgystep|
  EXPORT |r6502loadabsxstep|
  EXPORT |r6502loadabsystep|
  EXPORT |r6502linearloadabsxstep|
  EXPORT |r6502linearloadabsystep|
  EXPORT |r6502fixindexedstep|
  EXPORT |r6502bitstep|
  EXPORT |r6502orastep|
  EXPORT |r6502andstep|
  EXPORT |r6502eorstep|
  EXPORT |r6502adcstep|
  EXPORT |r6502ldastep|
  EXPORT |r6502ldxstep|
  EXPORT |r6502ldystep|
  EXPORT |r6502cmpstep|
  EXPORT |r6502cpxstep|
  EXPORT |r6502cpystep|
  EXPORT |r6502sbcstep|
  EXPORT |r6502skipstep|
  EXPORT |r6502laxstep|
  EXPORT |r6502lasstep|
  EXPORT |r6502ancstep|
  EXPORT |r6502alrstep|
  EXPORT |r6502arrstep|
  EXPORT |r6502xaastep|
  EXPORT |r6502oalstep|
  EXPORT |r6502sbxstep|
  EXPORT |r6502tozpgmodifystep|
  EXPORT |r6502tomodifystep|
  EXPORT |r6502aslastep|
  EXPORT |r6502aslzpgstep|
  EXPORT |r6502aslstep|
  EXPORT |r6502rolastep|
  EXPORT |r6502rolzpgstep|
  EXPORT |r6502rolstep|
  EXPORT |r6502lsrastep|
  EXPORT |r6502lsrzpgstep|
  EXPORT |r6502lsrstep|
  EXPORT |r6502rorastep|
  EXPORT |r6502rorzpgstep|
  EXPORT |r6502rorstep|
  EXPORT |r6502dexstep|
  EXPORT |r6502deystep|
  EXPORT |r6502deczpgstep|
  EXPORT |r6502decstep|
  EXPORT |r6502inxstep|
  EXPORT |r6502inystep|
  EXPORT |r6502inczpgstep|
  EXPORT |r6502incstep|
  EXPORT |r6502asozpgstep|
  EXPORT |r6502asostep|
  EXPORT |r6502rlazpgstep|
  EXPORT |r6502rlastep|
  EXPORT |r6502lsezpgstep|
  EXPORT |r6502lsestep|
  EXPORT |r6502rrazpgstep|
  EXPORT |r6502rrastep|
  EXPORT |r6502dcpzpgstep|
  EXPORT |r6502dcpstep|
  EXPORT |r6502isbzpgstep|
  EXPORT |r6502isbstep|
  EXPORT |r6502topushpstep|
  EXPORT |r6502topushastep|
  EXPORT |r6502loadzpgtostastep|
  EXPORT |r6502loadabstostastep|
  EXPORT |r6502loadzpgxtostastep|
  EXPORT |r6502fixindexedtostastep|
  EXPORT |r6502loadzpgtostxstep|
  EXPORT |r6502loadabstostxstep|
  EXPORT |r6502loadzpgytostxstep|
  EXPORT |r6502loadzpgtostystep|
  EXPORT |r6502loadabstostystep|
  EXPORT |r6502loadzpgxtostystep|
  EXPORT |r6502loadzpgtosaxstep|
  EXPORT |r6502loadzpgytosaxstep|
  EXPORT |r6502loadabstosaxstep|
  EXPORT |r6502fixindexedtoaxastep|
  EXPORT |r6502fixindexedtoxasstep|
  EXPORT |r6502fixindexedtosaystep|
  EXPORT |r6502fixindexedtotasstep|
  EXPORT |r6502pushedstep|
  EXPORT |r6502bplstep|
  EXPORT |r6502bmistep|
  EXPORT |r6502bvcstep|
  EXPORT |r6502bvsstep|
  EXPORT |r6502bccstep|
  EXPORT |r6502bcsstep|
  EXPORT |r6502bnestep|
  EXPORT |r6502beqstep|
  EXPORT |r6502branchtakenstep|
  EXPORT |r6502fixbranchtakenstep|
  EXPORT |r6502latchjmpabsindlostep|
  EXPORT |r6502loadpchstep|
  EXPORT |r6502waitonresetstep|
  EXPORT |r6502resetstep|
  EXPORT |r6502nooperandstep|
  EXPORT |r6502notpushedtonotpushstep|
  EXPORT |r6502breadcrumbnotpushedtoresetlostep|
  EXPORT |r6502pushedtobrkpushpclstep|
  EXPORT |r6502pushedtopushpclstep|
  EXPORT |r6502pushedtopushpstep|
  EXPORT |r6502pushedtopushpwithoutbstep|
  EXPORT |r6502breadcrumbpushedtointerruptlostep|
  EXPORT |r6502latchveclostep|
  EXPORT |r6502tobrkpushpchstep|
  EXPORT |r6502topushpchstep|
  EXPORT |r6502latchabslobeforepushstep|
  EXPORT |r6502tojsrpushpchstep|
  EXPORT |r6502pushedtojsrpushpclstep|
  EXPORT |r6502pushedtoloadpchstep|
  EXPORT |r6502pulledptopullstep|
  EXPORT |r6502pulledpclstep|
  EXPORT |r6502loadpchtoincrementstep|
  EXPORT |r6502midstretchstep|
  EXPORT |r6502stretchedreadstep|
  EXPORT |r6502stretcheddiscardstep|
  EXPORT |r6502stretchedwritestep|
  EXPORT |r6502opcodefetchreturn|
  EXPORT |r6502opcodeearlyinterruptfetchreturn|
  EXPORT |r6502opcodeinterruptfetchreturn|
  EXPORT |r6502startyield|
  EXPORT |r6502yieldstep|

  ASSERT :INDEX:R6502ZONE_AC == &0
  ASSERT :INDEX:R6502ZONE_BC == &108
  ASSERT :INDEX:R6502ZONE_CC == &400
  ASSERT :INDEX:R6502ZONE_DC == &1000
  ASSERT :INDEX:R6502ZONE_EC == &1C00
  ASSERT SIZEOF_R6502ZONEMAP == &4000

  ASSERT :INDEX:R6502_M_SHIFT == :INDEX:R6502ZONE_M_SHIFT
  ASSERT :INDEX:R6502_M == :INDEX:R6502ZONE_M

  ASSERT :INDEX:R6502_AP == :INDEX:R6502ZONE_AP
  ASSERT :INDEX:R6502_BP == :INDEX:R6502ZONE_BP
  ASSERT :INDEX:R6502_CP == :INDEX:R6502ZONE_CP
  ASSERT :INDEX:R6502_DP == :INDEX:R6502ZONE_DP
  ASSERT SIZEOF_R6502MAP == SIZEOF_R6502ZONEMAP

  ASSERT :INDEX:R6502_ADDRESSINGANDCYCLEOPS == (ADDRESSING_BASEFLAG-ADDRESSING_MODIFYFLAG):SHL:8

  MACRO
  R6502STARTSTRETCH1READSPECIAL
  STR r3,[r0,#:INDEX:R6502_STRETCHED_CPU_STATE]
  ADD r3,r0,#:INDEX:R6502_SEQUENCES
  STR r1,[r0,#:INDEX:R6502_STRETCHED_ADDRESS_CODE]
  LDR r1,[r3,#R6502_READ_STRETCH_SEQUENCE:SHL:2]
  ADD r1,r1,#1:SHL:2
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  MEND

  MACRO
  R6502STARTSTRETCH2READSPECIAL
  STR r3,[r0,#:INDEX:R6502_STRETCHED_CPU_STATE]
  ADD r3,r0,#:INDEX:R6502_SEQUENCES
  STR r1,[r0,#:INDEX:R6502_STRETCHED_ADDRESS_CODE]
  LDR r1,[r3,#R6502_READ_STRETCH_SEQUENCE:SHL:2]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  MEND

  MACRO
  R6502STARTSTRETCH1DISCARDSPECIAL
  STR r3,[r0,#:INDEX:R6502_STRETCHED_CPU_STATE]
  ADD r3,r0,#:INDEX:R6502_SEQUENCES
  STR r1,[r0,#:INDEX:R6502_STRETCHED_ADDRESS_CODE]
  LDR r1,[r3,#R6502_DISCARD_STRETCH_SEQUENCE:SHL:2]
  ADD r1,r1,#1:SHL:2
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  MEND

  MACRO
  R6502STARTSTRETCH2DISCARDSPECIAL
  STR r3,[r0,#:INDEX:R6502_STRETCHED_CPU_STATE]
  ADD r3,r0,#:INDEX:R6502_SEQUENCES
  STR r1,[r0,#:INDEX:R6502_STRETCHED_ADDRESS_CODE]
  LDR r1,[r3,#R6502_DISCARD_STRETCH_SEQUENCE:SHL:2]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  MEND

  MACRO
  R6502STARTSTRETCH1WRITESPECIAL
  STR r3,[r0,#:INDEX:R6502_STRETCHED_CPU_STATE]
  ADD r3,r0,#:INDEX:R6502_SEQUENCES
  STR r1,[r0,#:INDEX:R6502_STRETCHED_ADDRESS_CODE]
  LDR r1,[r3,#R6502_WRITE_STRETCH_SEQUENCE:SHL:2]
  ADD r1,r1,#1:SHL:2
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  MEND

  MACRO
  R6502STARTSTRETCH2WRITESPECIAL
  STR r3,[r0,#:INDEX:R6502_STRETCHED_CPU_STATE]
  ADD r3,r0,#:INDEX:R6502_SEQUENCES
  STR r1,[r0,#:INDEX:R6502_STRETCHED_ADDRESS_CODE]
  LDR r1,[r3,#R6502_WRITE_STRETCH_SEQUENCE:SHL:2]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  MEND

|r6502invokeaddressing|
  STMFD sp!,{r2,r6-r7,lr}
  AND r3,r1,#&F000000F
  ORR r6,r1,#ADDRESSING_MODIFYFLAG
  LDR r7,[r0,#:INDEX:R6502_SYNC_PC_CODE]
  R6502_INVOKE_ADDRESSING s_r6502invokeaddressing,s1_r6502invokeaddressing,s2_r6502invokeaddressing
  LDMFD sp!,{r2,r6-r7,lr}
  LDR pc,[r2, #12]
|s_r6502invokeaddressing|
  MOV r1,r6
  LDMFD sp!,{r2,r6-r7,lr}
  LDR pc,[r2]
|s1_r6502invokeaddressing|
  MOV r1,r6
  LDMFD sp!,{r2,r6-r7,lr}
  LDR pc,[r2, #4]
|s2_r6502invokeaddressing|
  MOV r1,r6
  LDMFD sp!,{r2,r6-r7,lr}
  LDR pc,[r2, #8]

|r6502cyclereadmappedreturn|
  R6502_CYCLE_READ_MAPPED_RETURN

|r6502cyclereadspecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cyclereadspecialreturn|
  R6502_CYCLE_READSPECIAL
  R6502_CYCLE_RETURN

|r6502cyclestretch1readspecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cyclestretch1readspecialreturn|
  LDR r3,[r0,#:INDEX:R6502_CPU_STATE]
  R6502STARTSTRETCH1READSPECIAL
  R6502_CYCLE_STRETCH_RETURN

|r6502cyclestretch2readspecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cyclestretch2readspecialreturn|
  LDR r3,[r0,#:INDEX:R6502_CPU_STATE]
  R6502STARTSTRETCH2READSPECIAL
  R6502_CYCLE_STRETCH_RETURN

|r6502cyclediscardmappedreturn|
  R6502_CYCLE_DISCARD_MAPPED_RETURN

|r6502cyclediscardspecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cyclediscardspecialreturn|
  LDRB r2,[r0,#:INDEX:R6502_M]
  STRB r2,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_READSPECIAL
  LDRB r2,[r0,#:INDEX:R6502_LATCH+2]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_RETURN

|r6502cyclestretch1discardspecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cyclestretch1discardspecialreturn|
  LDR r3,[r0,#:INDEX:R6502_CPU_STATE]
  R6502STARTSTRETCH1DISCARDSPECIAL
  R6502_CYCLE_STRETCH_RETURN

|r6502cyclestretch2discardspecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cyclestretch2discardspecialreturn|
  LDR r3,[r0,#:INDEX:R6502_CPU_STATE]
  R6502STARTSTRETCH2DISCARDSPECIAL
  R6502_CYCLE_STRETCH_RETURN

|r6502cyclewritemappedreturn|
  R6502_CYCLE_WRITE_MAPPED_RETURN

|r6502cyclewritespecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cyclewritespecialreturn|
  LDRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_WRITESPECIAL
  R6502_CYCLE_RETURN

|r6502cyclestretch1writespecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cyclestretch1writespecialreturn|
  LDR r3,[r0,#:INDEX:R6502_CPU_STATE]
  R6502STARTSTRETCH1WRITESPECIAL
  R6502_CYCLE_STRETCH_RETURN

|r6502cyclestretch2writespecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cyclestretch2writespecialreturn|
  LDR r3,[r0,#:INDEX:R6502_CPU_STATE]
  R6502STARTSTRETCH2WRITESPECIAL
  R6502_CYCLE_STRETCH_RETURN

r6502cyclefetchdointerrupt
  LDR r1,[r1,#R6502_INTERRUPT_SEQUENCE:SHL:2]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  R6502_CYCLE_RETURN

r6502cyclefetchdoyield
  ADD r1,r0,#:INDEX:R6502_SEQUENCES
  LDR r2,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r1,[r1,#R6502_YIELD_SEQUENCE:SHL:2]
  STR r2,[r0,#:INDEX:R6502_EXECUTE_CPU_STATE]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  R6502_CYCLE_RETURN

|r6502completecyclefetchreturn|
  ADD r1,r0,#:INDEX:R6502_SEQUENCES
  LDR r1,[r1,r2,LSL #2]
  CMP r3,#R6502_YIELD_TRANSITION
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  BEQ r6502cyclefetchdoyield
  R6502_CYCLE_RETURN

  MACRO
  CYCLELOGSPECIALFETCH
  STMFD sp!,{r4,lr}
  MOV r1,sp
  BL deferlogfetch
  LDMFD sp!,{r4,lr}
  MEND

|r6502cyclefetchmappedreturn|
  R6502_CYCLE_FETCH_MAPPED_RETURN

|r6502cyclefetchspecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cyclefetchspecialreturn|
  R6502_CYCLE_READSPECIAL
|r6502cyclefetchafterreadspecial|
  CYCLELOGSPECIALFETCH
  LDR r3,[r0,#:INDEX:R6502_TRANSITION1]
  LDRB r2,[r0,#:INDEX:R6502_M]
  CMP r3,#R6502_RESET_TRANSITION
  BNE r6502completecyclefetchreturn
  R6502_CYCLE_RESET_RETURN

|r6502cyclestretch1fetchspecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cyclestretch1fetchspecialreturn|
  ADD r2,r0,#:INDEX:R6502_SEQUENCES
  LDR r3,[r2,#R6502_READ_STRETCH_SEQUENCE:SHL:2]
  ADD r3,r3,#2:SHL:2
  R6502STARTSTRETCH1READSPECIAL
  R6502_CYCLE_STRETCH_RETURN

|r6502cyclestretch2fetchspecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cyclestretch2fetchspecialreturn|
  ADD r2,r0,#:INDEX:R6502_SEQUENCES
  LDR r3,[r2,#R6502_READ_STRETCH_SEQUENCE:SHL:2]
  ADD r3,r3,#2:SHL:2
  R6502STARTSTRETCH2READSPECIAL
  R6502_CYCLE_STRETCH_RETURN

|r6502completecycleearlyinterruptfetchreturn|
  TST r1,#R6502_NMI_IRQ_ENABLE:SHL:12
  ADD r1,r0,#:INDEX:R6502_SEQUENCES
  BNE r6502cyclefetchdointerrupt
  LDR r1,[r1,r2,LSL #2]
  CMP r3,#R6502_YIELD_TRANSITION
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  BEQ r6502cyclefetchdoyield
  R6502_CYCLE_RETURN

|r6502cycleearlyinterruptfetchmappedreturn|
  R6502_CYCLE_EARLY_INTERRUPT_CHECK_FETCH_MAPPED_RETURN

|r6502cycleearlyinterruptfetchspecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cycleearlyinterruptfetchspecialreturn|
  R6502_CYCLE_READSPECIAL
|r6502cycleearlyinterruptfetchafterreadspecial|
  CYCLELOGSPECIALFETCH
  LDR r3,[r0,#:INDEX:R6502_TRANSITION1]
  LDRB r2,[r0,#:INDEX:R6502_M]
  LDR r1,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  CMP r3,#R6502_RESET_TRANSITION
  AND r1,r1,r1,LSR #6
  BNE r6502completecycleearlyinterruptfetchreturn
  R6502_CYCLE_RESET_RETURN

|r6502cycleearlyinterruptstretch1fetchspecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cycleearlyinterruptstretch1fetchspecialreturn|
  ADD r2,r0,#:INDEX:R6502_SEQUENCES
  LDR r3,[r2,#R6502_READ_STRETCH_SEQUENCE:SHL:2]
  ADD r3,r3,#2:SHL:3
  R6502STARTSTRETCH1READSPECIAL
  R6502_CYCLE_STRETCH_RETURN

|r6502cycleearlyinterruptstretch2fetchspecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cycleearlyinterruptstretch2fetchspecialreturn|
  ADD r2,r0,#:INDEX:R6502_SEQUENCES
  LDR r3,[r2,#R6502_READ_STRETCH_SEQUENCE:SHL:2]
  ADD r3,r3,#2:SHL:3
  R6502STARTSTRETCH2READSPECIAL
  R6502_CYCLE_STRETCH_RETURN

|r6502completecycleinterruptfetchreturn|
  TST r1,#R6502_NMI_IRQ_ENABLE:SHL:8
  ADD r1,r0,#:INDEX:R6502_SEQUENCES
  BNE r6502cyclefetchdointerrupt
  LDR r1,[r1,r2,LSL #2]
  CMP r3,#R6502_YIELD_TRANSITION
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  BEQ r6502cyclefetchdoyield
  R6502_CYCLE_RETURN

|r6502cycleinterruptfetchmappedreturn|
  R6502_CYCLE_INTERRUPT_CHECK_FETCH_MAPPED_RETURN

|r6502cycleinterruptfetchspecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cycleinterruptfetchspecialreturn|
  R6502_CYCLE_READSPECIAL
|r6502cycleinterruptfetchafterreadspecial|
  CYCLELOGSPECIALFETCH
  LDR r3,[r0,#:INDEX:R6502_TRANSITION1]
  LDRB r2,[r0,#:INDEX:R6502_M]
  LDR r1,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  CMP r3,#R6502_RESET_TRANSITION
  AND r1,r1,r1,LSR #6
  BNE r6502completecycleinterruptfetchreturn
  R6502_CYCLE_RESET_RETURN

|r6502cycleinterruptstretch1fetchspecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cycleinterruptstretch1fetchspecialreturn|
  ADD r2,r0,#:INDEX:R6502_SEQUENCES
  LDR r3,[r2,#R6502_READ_STRETCH_SEQUENCE:SHL:2]
  ADD r3,r3,#2:SHL:4
  R6502STARTSTRETCH1READSPECIAL
  R6502_CYCLE_STRETCH_RETURN

|r6502cycleinterruptstretch2fetchspecialpopreturn|
  MOV r1,r6
  R6502_CYCLE_ADDRESSING_POP
|r6502cycleinterruptstretch2fetchspecialreturn|
  ADD r2,r0,#:INDEX:R6502_SEQUENCES
  LDR r3,[r2,#R6502_READ_STRETCH_SEQUENCE:SHL:2]
  ADD r3,r3,#2:SHL:4
  R6502STARTSTRETCH2READSPECIAL
  R6502_CYCLE_STRETCH_RETURN

;// IMPLIED STEPS
|r6502operandstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ADD r6,r7,#1:SHL:16
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502nopstep|
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502clcstep|
  R6502_CYCLE_UPDATE_PUSH
  BIC r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502secstep|
  R6502_CYCLE_UPDATE_PUSH
  ORR r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502clistep|
  LDR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  ORR r3,r3,#R6502_IRQ_ENABLE
  STR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502seistep|
  LDR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  BIC r3,r3,#R6502_IRQ_ENABLE
  STR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502cldstep|
  R6502_CYCLE_UPDATE_PUSH
  BIC r8,r8,#DFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502sedstep|
  R6502_CYCLE_UPDATE_PUSH
  ORR r8,r8,#DFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502clvstep|
  R6502_CYCLE_UPDATE_PUSH
  BIC r8,r8,#VFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502taxstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r2,[r0,#:INDEX:R6502_A]
  BIC r8,r8,#NFLAG|ZFLAG
  MOVS r3,r2,LSL #24
  ORRMI r8,r8,#NFLAG
  STRB r2,[r0,#:INDEX:R6502_X]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502taystep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r2,[r0,#:INDEX:R6502_A]
  BIC r8,r8,#NFLAG|ZFLAG
  MOVS r3,r2,LSL #24
  ORRMI r8,r8,#NFLAG
  STRB r2,[r0,#:INDEX:R6502_Y]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502txastep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r2,[r0,#:INDEX:R6502_X]
  BIC r8,r8,#NFLAG|ZFLAG
  MOVS r3,r2,LSL #24
  ORRMI r8,r8,#NFLAG
  STRB r2,[r0,#:INDEX:R6502_A]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502txsstep|
  LDRB r2,[r0,#:INDEX:R6502_X]
  STRB r2,[r0,#:INDEX:R6502_SP_CODE+3]
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502tyastep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r2,[r0,#:INDEX:R6502_Y]
  BIC r8,r8,#NFLAG|ZFLAG
  MOVS r3,r2,LSL #24
  ORRMI r8,r8,#NFLAG
  STRB r2,[r0,#:INDEX:R6502_A]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502tsxstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r2,[r0,#:INDEX:R6502_SP_CODE+3]
  BIC r8,r8,#NFLAG|ZFLAG
  MOVS r3,r2,LSL #24
  ORRMI r8,r8,#NFLAG
  STRB r2,[r0,#:INDEX:R6502_X]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502pulledastep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r2,[r0,#:INDEX:R6502_M]
  BIC r8,r8,#NFLAG|ZFLAG
  MOVS r3,r2,LSL #24
  ORRMI r8,r8,#NFLAG
  STRB r2,[r0,#:INDEX:R6502_A]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502pulledpstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r2,[r0,#:INDEX:R6502_M]
  LDR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  TST r2,#IFLAG
  BICNE r3,r3,#R6502_IRQ_ENABLE
  ORREQ r3,r3,#R6502_IRQ_ENABLE
  ORR r8,r2,#UFLAG|BFLAG|IFLAG
  STR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502hltstep|
  LDR r3,[r0,#:INDEX:R6502_TRANSITION1]
  CMP r3,#R6502_RESET_TRANSITION
  BNE r6502hltstep2
  ADD r1,r0,#:INDEX:R6502_SEQUENCES
  LDR r1,[r1,#R6502_RESET_SEQUENCE:SHL:2]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  R6502_CYCLE_RETURN
r6502hltstep2
  CMP r3,#R6502_YIELD_TRANSITION
  BEQ r6502hltstep3
  R6502_CYCLE_RETURN
r6502hltstep3
  ADD r1,r0,#:INDEX:R6502_SEQUENCES
  LDR r2,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r1,[r1,#R6502_YIELD_SEQUENCE:SHL:2]
  STR r2,[r0,#:INDEX:R6502_EXECUTE_CPU_STATE]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  R6502_CYCLE_RETURN

;// LOAD STEPS
|r6502beforepullstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_SP_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_READ_RETURN

|r6502topullstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_SP_CODE]
  ADD r6,r2,#1:SHL:24
  STR r6,[r0,#:INDEX:R6502_SP_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_READ_RETURN

|r6502toimmediatestep|
  R6502_CYCLE_UPDATE_PUSH
  ADD r6,r7,#1:SHL:16
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  STR r6,[r0,#:INDEX:R6502_LAST_PC_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502breadcrumbloadzpgstep|
  R6502_CYCLE_UPDATE_PUSH
  ADD r2,r7,#1:SHL:16
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_M_SHIFT]
  STR r2,[r0,#:INDEX:R6502_LAST_PC_CODE]
  STR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_READ_RETURN

|r6502loadzpgstep|
  R6502_CYCLE_UPDATE_PUSH
  ADD r2,r7,#1:SHL:16
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_M_SHIFT]
  STR r2,[r0,#:INDEX:R6502_LAST_PC_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_READ_RETURN

|r6502breadcrumblatchabslostep|
  R6502_CYCLE_UPDATE_PUSH
  ADD r6,r7,#2:SHL:16
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDRB r2,[r0,#:INDEX:R6502_M]
  STR r6,[r0,#:INDEX:R6502_LAST_PC_CODE]
  STR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  STRB r2,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502latchabslostep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ADD r6,r7,#2:SHL:16
  LDRB r2,[r0,#:INDEX:R6502_M]
  STR r6,[r0,#:INDEX:R6502_LAST_PC_CODE]
  STRB r2,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502breadcrumbloadabsstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r6,[r0,#:INDEX:R6502_M]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ORR r6,r2,r6,LSL #24
  ORR r6,r6,#ADDRESSING_BASEFLAG
  STR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502loadabsstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r6,[r0,#:INDEX:R6502_M]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ORR r6,r2,r6,LSL #24
  ORR r6,r6,#ADDRESSING_BASEFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502breadcrumblatchzpgindlostep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  LDRB r2,[r0,#:INDEX:R6502_M]
  ADD r6,r6,#1:SHL:24
  STRB r2,[r0,#:INDEX:R6502_LATCH+2]
  STR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_READ_RETURN

|r6502latchzpgindlostep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  LDRB r2,[r0,#:INDEX:R6502_M]
  ADD r6,r6,#1:SHL:24
  STRB r2,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_READ_RETURN

|r6502breadcrumbloadzpgxstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  LDRB r2,[r0,#:INDEX:R6502_X]
  ADD r6,r6,r2,LSL #24
  STR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_READ_RETURN

|r6502loadzpgxstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  LDRB r2,[r0,#:INDEX:R6502_X]
  ADD r6,r6,r2,LSL #24
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_READ_RETURN

|r6502loadzpgystep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  LDRB r2,[r0,#:INDEX:R6502_Y]
  ADD r6,r6,r2,LSL #24
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_READ_RETURN

|r6502loadabsxstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r3,[r0,#:INDEX:R6502_X]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  LDRB r6,[r0,#:INDEX:R6502_M]
  ADD r2,r2,r3,LSL #16
  TST r2,#1:SHL:24
  ADD r6,r2,r6,LSL #24
  ADDEQ r1,r1,#1:SHL:2
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ORR r6,r6,#ADDRESSING_BASEFLAG
  STR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  SUBNE r6,r6,#1:SHL:24
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502loadabsystep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r3,[r0,#:INDEX:R6502_Y]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  LDRB r6,[r0,#:INDEX:R6502_M]
  ADD r2,r2,r3,LSL #16
  TST r2,#1:SHL:24
  ADD r6,r2,r6,LSL #24
  ADDEQ r1,r1,#1:SHL:2
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ORR r6,r6,#ADDRESSING_BASEFLAG
  STR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  SUBNE r6,r6,#1:SHL:24
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502linearloadabsxstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r3,[r0,#:INDEX:R6502_X]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  LDRB r6,[r0,#:INDEX:R6502_M]
  ADD r2,r2,r3,LSL #16
  TST r2,#1:SHL:24
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ADD r6,r2,r6,LSL #24
  ORR r6,r6,#ADDRESSING_BASEFLAG
  STR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  SUBNE r6,r6,#1:SHL:24
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502linearloadabsystep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r3,[r0,#:INDEX:R6502_Y]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  LDRB r6,[r0,#:INDEX:R6502_M]
  ADD r2,r2,r3,LSL #16
  TST r2,#1:SHL:24
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ADD r6,r2,r6,LSL #24
  ORR r6,r6,#ADDRESSING_BASEFLAG
  STR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  SUBNE r6,r6,#1:SHL:24
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502fixindexedstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502bitstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r1,[r0,#:INDEX:R6502_A]
  LDRB r2,[r0,#:INDEX:R6502_M]
  TST r1,r2
  BIC r8,r8,#NFLAG|VFLAG|ZFLAG
  AND r3,r2,#NFLAG|VFLAG
  ORREQ r8,r8,#ZFLAG
  ORR r8,r8,r3
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502orastep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r1,[r0,#:INDEX:R6502_A_SHIFT]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG
  ORRS r1,r1,r2
  ORRMI r8,r8,#NFLAG
  STR r1,[r0,#:INDEX:R6502_A_SHIFT]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502andstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r1,[r0,#:INDEX:R6502_A_SHIFT]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG
  ANDS r1,r1,r2
  ORRMI r8,r8,#NFLAG
  STR r1,[r0,#:INDEX:R6502_A_SHIFT]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502eorstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r1,[r0,#:INDEX:R6502_A_SHIFT]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG
  EORS r1,r1,r2
  ORRMI r8,r8,#NFLAG
  STR r1,[r0,#:INDEX:R6502_A_SHIFT]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502adcstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r1,[r0,#:INDEX:R6502_A]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  TST r8,#DFLAG
  BNE r6502adcstepD
  TEQ r2,r8,LSR #1   ;jdl** ARM c =6502 c
  SUB r1,r1,#1:SHL:8
  BIC r8,r8,#NFLAG|VFLAG|ZFLAG|CFLAG
  ADCS r1,r2,r1,ROR #8
  ORRMI r8,r8,#NFLAG
  ORRVS r8,r8,#VFLAG
  ORRCS r8,r8,#CFLAG
  MOVS r1,r1,LSR#24 ;(a=(a>>24) jdl** also (z=(a=0))
  ORREQ r8,r8,#ZFLAG
  STRB r1,[r0,#:INDEX:R6502_A]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN
r6502adcstepD
  TEQ r2,r8,LSR #1   ;jdl** ARM c =6502 c
  ORR r1,r1,r1,ROR #8
  ORR r2,r2,#&000FF000
  AND r1,r1,#&F000000F
  ORR r2,r2,#&00000FF0
  ADD r1,r1,#6
  ORR r2,r2,r2,ROR #24
  BIC r8,r8,#NFLAG|VFLAG|ZFLAG|CFLAG
  ADCS r1,r1,r2
  ORRMI r8,r8,#NFLAG
  ORRVS r8,r8,#VFLAG
  CMPCC r1,#&A0000000
  SUB r2,r1,#6
  ADDCS r1,r1,#&60000000
  ORRCS r8,r8,#CFLAG
  TST r1,#&80
  SUBNE r1,r1,#6
  AND r1,r1,#&F000000F
  TST r2,#&F000000F
  ORR r1,r1,r1,LSR #24
  ORREQ r8,r8,#ZFLAG
  STRB r1,[r0,#:INDEX:R6502_A]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502ldastep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r2,[r0,#:INDEX:R6502_M]
  BIC r8,r8,#NFLAG|ZFLAG
  MOVS r3,r2,LSL #24
  ORRMI r8,r8,#NFLAG
  STRB r2,[r0,#:INDEX:R6502_A]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502ldxstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r2,[r0,#:INDEX:R6502_M]
  BIC r8,r8,#NFLAG|ZFLAG
  MOVS r3,r2,LSL #24
  ORRMI r8,r8,#NFLAG
  STRB r2,[r0,#:INDEX:R6502_X]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502ldystep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r2,[r0,#:INDEX:R6502_M]
  BIC r8,r8,#NFLAG|ZFLAG
  MOVS r3,r2,LSL #24
  ORRMI r8,r8,#NFLAG
  STRB r2,[r0,#:INDEX:R6502_Y]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502cmpstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r1,[r0,#:INDEX:R6502_A_SHIFT]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  SUBS r1,r1,r2
  ORRMI r8,r8,#NFLAG
  ORREQ r8,r8,#ZFLAG
  ORRCS r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502cpxstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r1,[r0,#:INDEX:R6502_X_SHIFT]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  SUBS r1,r1,r2
  ORRMI r8,r8,#NFLAG
  ORREQ r8,r8,#ZFLAG
  ORRCS r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502cpystep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r1,[r0,#:INDEX:R6502_Y_SHIFT]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  SUBS r1,r1,r2
  ORRMI r8,r8,#NFLAG
  ORREQ r8,r8,#ZFLAG
  ORRCS r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502sbcstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r1,[r0,#:INDEX:R6502_A]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  TST r8,#DFLAG
  BNE r6502sbcstepD
  TEQ r2,r8,LSR #1   ;jdl** ARM c =6502 c
  BIC r8,r8,#NFLAG|VFLAG|ZFLAG|CFLAG
  RSCS r1,r2,r1,ROR #8
  ORRMI r8,r8,#NFLAG
  ORRVS r8,r8,#VFLAG
  ORRCS r8,r8,#CFLAG
  MOVS r1,r1,LSR#24 ;(a=(a>>24) jdl** also (z=(a=0))
  ORREQ r8,r8,#ZFLAG
  STRB r1,[r0,#:INDEX:R6502_A]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN
r6502sbcstepD
  TEQ r2,r8,LSR #1   ;jdl** ARM c =6502 c
  ORR r2,r2,r2,ROR #24
  ORR r1,r1,r1,ROR #8
  AND r2,r2,#&F000000F
  AND r1,r1,#&F000000F
  MVN r2,r2
  BIC r8,r8,#NFLAG|VFLAG|ZFLAG|CFLAG
  ADCS r1,r1,r2
  ORRCS r8,r8,#CFLAG
  ORRMI r8,r8,#NFLAG
  ORRVS r8,r8,#VFLAG
  MOV r2,r1
  SUBCC r1,r1,#&60000000
  TST r1,#&80
  SUBNE r1,r1,#6
  AND r1,r1,#&F000000F
  TST r2,#&F000000F
  ORR r1,r1,r1,LSR #24
  ORREQ r8,r8,#ZFLAG
  STRB r1,[r0,#:INDEX:R6502_A]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502skipstep|
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502laxstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r2,[r0,#:INDEX:R6502_M]
  BIC r8,r8,#NFLAG|ZFLAG
  MOVS r3,r2,LSL #24
  ORRMI r8,r8,#NFLAG
  STRB r2,[r0,#:INDEX:R6502_A]
  STRB r2,[r0,#:INDEX:R6502_X]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502lasstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r1,[r0,#:INDEX:R6502_SP_CODE]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG
  ANDS r2,r1,r2
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_SP_CODE]
  STR r2,[r0,#:INDEX:R6502_A_SHIFT]
  STR r2,[r0,#:INDEX:R6502_X_SHIFT]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502ancstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r1,[r0,#:INDEX:R6502_A_SHIFT]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  ANDS r2,r2,r1
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_A_SHIFT]
  ORREQ r8,r8,#ZFLAG
  ORRMI r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502alrstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r1,[r0,#:INDEX:R6502_A]
  LDRB r2,[r0,#:INDEX:R6502_M]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  AND r2,r2,r1
  MOVS r1,r2,LSR #1
  ORREQ r8,r8,#ZFLAG
  STRB r1,[r0,#:INDEX:R6502_A]
  ORRCS r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502arrstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r1,[r0,#:INDEX:R6502_A]
  LDRB r2,[r0,#:INDEX:R6502_M]
  MOVS r3,r8,LSL #31
  AND r2,r2,r1
  BIC r8,r8,#NFLAG|VFLAG|ZFLAG|CFLAG
  MOV r1,r3,LSR #24
  ORRMI r8,r8,#NFLAG
  ORRS r1,r1,r2,LSR #1
  ORREQ r8,r8,#ZFLAG
  ORR r8,r8,r1,LSL #25
  EORS r8,r8,r2,LSL #25
  ORRMI r8,r8,#VFLAG
  TST r8,#DFLAG
  BNE r6502arrstepD
  TST r2,#NFLAG
  ORRNE r8,r8,#CFLAG
  STRB r1,[r0,#:INDEX:R6502_A]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN
r6502arrstepD
  CMP r2,#&50
  ADDHS r1,r1,#&60
  ORRHS r8,r8,#CFLAG
  AND r2,r2,#&0F
  CMP r2,#&05
  MOVHS r1,r1,ROR #4
  ADDHS r1,r1,#&60000000
  MOVHS r1,r1,ROR #28
  STRB r1,[r0,#:INDEX:R6502_A]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502xaastep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r1,[r0,#:INDEX:R6502_X_SHIFT]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG
  ANDS r2,r1,r2
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_A_SHIFT]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502oalstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r1,[r0,#:INDEX:R6502_A_SHIFT]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  ORR r1,r1,#&EE000000
  BIC r8,r8,#NFLAG|ZFLAG
  ANDS r2,r1,r2
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_A_SHIFT]
  STR r2,[r0,#:INDEX:R6502_X_SHIFT]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

|r6502sbxstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r1,[r0,#:INDEX:R6502_A_SHIFT]
  LDR r2,[r0,#:INDEX:R6502_X_SHIFT]
  AND r1,r1,r2
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  SUBS r1,r1,r2
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  STR r1,[r0,#:INDEX:R6502_X_SHIFT]
  ORRMI r8,r8,#NFLAG
  ORREQ r8,r8,#ZFLAG
  ORRCS r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ADDRESSED_INTERRUPT_CHECK_FETCH_RETURN

;// MODIFY STEP
|r6502tozpgmodifystep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502tomodifystep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502aslastep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r2,[r0,#:INDEX:R6502_A_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  MOVS r2,r2,LSL #1
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_A_SHIFT]
  ORREQ r8,r8,#ZFLAG
  ORRCS r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502aslzpgstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  MOVS r2,r2,LSL #1
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_M_SHIFT]
  ORREQ r8,r8,#ZFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  ORRCS r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502aslstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  MOVS r2,r2,LSL #1
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_M_SHIFT]
  ORREQ r8,r8,#ZFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  ORRCS r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502rolastep|
  R6502_CYCLE_UPDATE_PUSH
  TST r8,#CFLAG
  LDR r2,[r0,#:INDEX:R6502_A_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  ORRNE r2,r2,#&800000
  MOVS r2,r2,LSL #1
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_A_SHIFT]
  ORREQ r8,r8,#ZFLAG
  ORRCS r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502rolzpgstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#CFLAG
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  ORRNE r2,r2,#&800000
  MOVS r2,r2,LSL #1
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_M_SHIFT]
  ORREQ r8,r8,#ZFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  ORRCS r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502rolstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#CFLAG
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  ORRNE r2,r2,#&800000
  MOVS r2,r2,LSL #1
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_M_SHIFT]
  ORREQ r8,r8,#ZFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  ORRCS r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502lsrastep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r2,[r0,#:INDEX:R6502_A]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  MOVS r2,r2,LSR #1
  ORREQ r8,r8,#ZFLAG
  STRB r2,[r0,#:INDEX:R6502_A]
  ORRCS r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502lsrzpgstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDRB r2,[r0,#:INDEX:R6502_M]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  MOVS r2,r2,LSR #1
  ORREQ r8,r8,#ZFLAG
  STRB r2,[r0,#:INDEX:R6502_M]
  ORRCS r8,r8,#CFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502lsrstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDRB r2,[r0,#:INDEX:R6502_M]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  MOVS r2,r2,LSR #1
  ORREQ r8,r8,#ZFLAG
  STRB r2,[r0,#:INDEX:R6502_M]
  ORRCS r8,r8,#CFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502rorastep|
  R6502_CYCLE_UPDATE_PUSH
  TST r8,#CFLAG
  LDRB r2,[r0,#:INDEX:R6502_A]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  ORRNE r2,r2,#&100
  ORRNE r8,r8,#NFLAG
  MOVS r2,r2,LSR #1
  ORREQ r8,r8,#ZFLAG
  STRB r2,[r0,#:INDEX:R6502_A]
  ORRCS r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502rorzpgstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#CFLAG
  LDRB r2,[r0,#:INDEX:R6502_M]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  ORRNE r2,r2,#&100
  ORRNE r8,r8,#NFLAG
  MOVS r2,r2,LSR #1
  ORREQ r8,r8,#ZFLAG
  STRB r2,[r0,#:INDEX:R6502_M]
  ORRCS r8,r8,#CFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502rorstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#CFLAG
  LDRB r2,[r0,#:INDEX:R6502_M]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  ORRNE r2,r2,#&100
  ORRNE r8,r8,#NFLAG
  MOVS r2,r2,LSR #1
  ORREQ r8,r8,#ZFLAG
  STRB r2,[r0,#:INDEX:R6502_M]
  ORRCS r8,r8,#CFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502dexstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r2,[r0,#:INDEX:R6502_X_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG
  SUBS r2,r2,#1:SHL:24
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_X_SHIFT]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502deystep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r2,[r0,#:INDEX:R6502_Y_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG
  SUBS r2,r2,#1:SHL:24
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_Y_SHIFT]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502deczpgstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG
  SUBS r2,r2,#1:SHL:24
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_M_SHIFT]
  ORREQ r8,r8,#ZFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502decstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG
  SUBS r2,r2,#1:SHL:24
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_M_SHIFT]
  ORREQ r8,r8,#ZFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502inxstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r2,[r0,#:INDEX:R6502_X_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG
  ADDS r2,r2,#1:SHL:24
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_X_SHIFT]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502inystep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r2,[r0,#:INDEX:R6502_Y_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG
  ADDS r2,r2,#1:SHL:24
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_Y_SHIFT]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

|r6502inczpgstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG
  ADDS r1,r2,#1:SHL:24
  ORRMI r8,r8,#NFLAG
  STR r1,[r0,#:INDEX:R6502_M_SHIFT]
  ORREQ r8,r8,#ZFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502incstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG
  ADDS r2,r2,#1:SHL:24
  ORRMI r8,r8,#NFLAG
  STR r2,[r0,#:INDEX:R6502_M_SHIFT]
  ORREQ r8,r8,#ZFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502asozpgstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r1,[r0,#:INDEX:R6502_A_SHIFT]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  MOVS r2,r2,LSL #1
  ORRCS r8,r8,#CFLAG
  STR r2,[r0,#:INDEX:R6502_M_SHIFT]
  ORRS r1,r1,r2
  ORRMI r8,r8,#NFLAG
  STR r1,[r0,#:INDEX:R6502_A_SHIFT]
  ORREQ r8,r8,#ZFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502asostep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r1,[r0,#:INDEX:R6502_A_SHIFT]
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  MOVS r2,r2,LSL #1
  ORRCS r8,r8,#CFLAG
  STR r2,[r0,#:INDEX:R6502_M_SHIFT]
  ORRS r1,r1,r2
  ORRMI r8,r8,#NFLAG
  STR r1,[r0,#:INDEX:R6502_A_SHIFT]
  ORREQ r8,r8,#ZFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502rlazpgstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#CFLAG
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  ORRNE r2,r2,#&800000
  MOVS r1,r2,LSL #1
  LDR r2,[r0,#:INDEX:R6502_A_SHIFT]
  STR r1,[r0,#:INDEX:R6502_M_SHIFT]
  ORRCS r8,r8,#CFLAG
  ANDS r1,r1,r2
  STR r1,[r0,#:INDEX:R6502_A_SHIFT]
  ORRMI r8,r8,#NFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502rlastep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#CFLAG
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  ORRNE r2,r2,#&800000
  MOVS r1,r2,LSL #1
  LDR r2,[r0,#:INDEX:R6502_A_SHIFT]
  STR r1,[r0,#:INDEX:R6502_M_SHIFT]
  ORRCS r8,r8,#CFLAG
  ANDS r1,r1,r2
  STR r1,[r0,#:INDEX:R6502_A_SHIFT]
  ORRMI r8,r8,#NFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502lsezpgstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r1,[r0,#:INDEX:R6502_A_SHIFT]
  LDRB r2,[r0,#:INDEX:R6502_M]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  MOVS r2,r2,LSR #1
  ORRCS r8,r8,#CFLAG
  STRB r2,[r0,#:INDEX:R6502_M]
  EORS r1,r1,r2,LSL #24
  STR r1,[r0,#:INDEX:R6502_A_SHIFT]
  ORRMI r8,r8,#NFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502lsestep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r1,[r0,#:INDEX:R6502_A_SHIFT]
  LDRB r2,[r0,#:INDEX:R6502_M]
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  MOVS r2,r2,LSR #1
  ORRCS r8,r8,#CFLAG
  STRB r2,[r0,#:INDEX:R6502_M]
  EORS r1,r1,r2,LSL #24
  STR r1,[r0,#:INDEX:R6502_A_SHIFT]
  ORRMI r8,r8,#NFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  ORREQ r8,r8,#ZFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502rrazpgstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#CFLAG
  LDRB r2,[r0,#:INDEX:R6502_M]
  LDRB r1,[r0,#:INDEX:R6502_A]
  ORRNE r2,r2,#&100
  TST r8,#DFLAG
  BNE r6502rrazpgstepD
  MOVS r2,r2,LSR #1
  STRB r2,[r0,#:INDEX:R6502_M]
  MOV r2,r2,LSL #24
  SUB r1,r1,#1:SHL:8
  BIC r8,r8,#NFLAG|VFLAG|ZFLAG|CFLAG
  ADCS r1,r2,r1,ROR #8
  ORRMI r8,r8,#NFLAG
  ORRVS r8,r8,#VFLAG
  ORRCS r8,r8,#CFLAG
  MOVS r1,r1,LSR#24 ;(a=(a>>24) jdl** also (z=(a=0))
  ORREQ r8,r8,#ZFLAG
  STRB r1,[r0,#:INDEX:R6502_A]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN
r6502rrazpgstepD
  MOVS r2,r2,LSR #1
  ORR r1,r1,r1,ROR #8
  STRB r2,[r0,#:INDEX:R6502_M]
  ORR r2,r2,#&0FF00000
  AND r1,r1,#&F000000F
  ORR r2,r2,#&000FF000
  ADD r1,r1,#6
  ORR r2,r2,r2,ROR #8
  BIC r8,r8,#NFLAG|VFLAG|ZFLAG|CFLAG
  ADCS r1,r1,r2
  ORRMI r8,r8,#NFLAG
  ORRVS r8,r8,#VFLAG
  CMPCC r1,#&A0000000
  SUB r2,r1,#6
  ADDCS r1,r1,#&60000000
  ORRCS r8,r8,#CFLAG
  TST r1,#&80
  SUBNE r1,r1,#6
  AND r1,r1,#&F000000F
  ORR r1,r1,r1,LSR #24
  TST r2,#&F000000F
  ORREQ r8,r8,#ZFLAG
  STRB r1,[r0,#:INDEX:R6502_A]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502rrastep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#CFLAG
  LDRB r2,[r0,#:INDEX:R6502_M]
  LDRB r1,[r0,#:INDEX:R6502_A]
  ORRNE r2,r2,#&100
  TST r8,#DFLAG
  BNE r6502rrastepD
  MOVS r2,r2,LSR #1
  STRB r2,[r0,#:INDEX:R6502_M]
  MOV r2,r2,LSL #24
  SUB r1,r1,#1:SHL:8
  BIC r8,r8,#NFLAG|VFLAG|ZFLAG|CFLAG
  ADCS r1,r2,r1,ROR #8
  ORRMI r8,r8,#NFLAG
  ORRVS r8,r8,#VFLAG
  ORRCS r8,r8,#CFLAG
  MOVS r1,r1,LSR#24 ;(a=(a>>24) jdl** also (z=(a=0))
  ORREQ r8,r8,#ZFLAG
  STRB r1,[r0,#:INDEX:R6502_A]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN
r6502rrastepD
  MOVS r2,r2,LSR #1
  ORR r1,r1,r1,ROR #8
  STRB r2,[r0,#:INDEX:R6502_M]
  ORR r2,r2,#&0FF00000
  AND r1,r1,#&F000000F
  ORR r2,r2,#&000FF000
  ADD r1,r1,#6
  ORR r2,r2,r2,ROR #8
  BIC r8,r8,#NFLAG|VFLAG|ZFLAG|CFLAG
  ADCS r1,r1,r2
  ORRMI r8,r8,#NFLAG
  ORRVS r8,r8,#VFLAG
  CMPCC r1,#&A0000000
  SUB r2,r1,#6
  ADDCS r1,r1,#&60000000
  ORRCS r8,r8,#CFLAG
  TST r1,#&80
  SUBNE r1,r1,#6
  AND r1,r1,#&F000000F
  ORR r1,r1,r1,LSR #24
  TST r2,#&F000000F
  ORREQ r8,r8,#ZFLAG
  STRB r1,[r0,#:INDEX:R6502_A]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502dcpzpgstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  SUB r2,r2,#1:SHL:24
  LDRB r1,[r0,#:INDEX:R6502_A]
  STR r2,[r0,#:INDEX:R6502_M_SHIFT]
  ADD r1,r1,#1:SHL:8
  SUB r1,r1,r2,LSR #24
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  MOVS r2,r1,LSL #24
  ORRMI r8,r8,#NFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  ORREQ r8,r8,#ZFLAG
  ORRCS r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502dcpstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  SUB r2,r2,#1:SHL:24
  LDRB r1,[r0,#:INDEX:R6502_A]
  STR r2,[r0,#:INDEX:R6502_M_SHIFT]
  ADD r1,r1,#1:SHL:8
  SUB r1,r1,r2,LSR #24
  BIC r8,r8,#NFLAG|ZFLAG|CFLAG
  MOVS r2,r1,LSL #24
  ORRMI r8,r8,#NFLAG
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  ORREQ r8,r8,#ZFLAG
  ORRCS r8,r8,#CFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502isbzpgstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ADD r2,r2,#1:SHL:24
  LDRB r1,[r0,#:INDEX:R6502_A]
  STR r2,[r0,#:INDEX:R6502_M_SHIFT]
  TST r8,#DFLAG
  BNE r6502isbzpgstepD
  TEQ r2,r8,LSR #1   ;jdl** ARM c =6502 c
  BIC r8,r8,#NFLAG|VFLAG|ZFLAG|CFLAG
  RSCS r1,r2,r1,ROR #8
  ORRMI r8,r8,#NFLAG
  ORRVS r8,r8,#VFLAG
  ORRCS r8,r8,#CFLAG
  MOVS r1,r1,LSR#24 ;(a=(a>>24) jdl** also (z=(a=0))
  ORREQ r8,r8,#ZFLAG
  STRB r1,[r0,#:INDEX:R6502_A]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN
r6502isbzpgstepD
  TEQ r2,r8,LSR #1   ;jdl** ARM c =6502 c
  ORR r2,r2,r2,ROR #24
  ORR r1,r1,r1,ROR #8
  AND r2,r2,#&F000000F
  AND r1,r1,#&F000000F
  MVN r2,r2
  BIC r8,r8,#NFLAG|VFLAG|ZFLAG|CFLAG
  ADCS r1,r1,r2
  ORRCS r8,r8,#CFLAG
  ORRMI r8,r8,#NFLAG
  ORRVS r8,r8,#VFLAG
  MOV r2,r1
  SUBCC r1,r1,#&60000000
  TST r1,#&80
  SUBNE r1,r1,#6
  AND r1,r1,#&F000000F
  TST r2,#&F000000F
  ORR r1,r1,r1,LSR #24
  ORREQ r8,r8,#ZFLAG
  STRB r1,[r0,#:INDEX:R6502_A]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502isbstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r2,[r0,#:INDEX:R6502_M_SHIFT]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ADD r2,r2,#1:SHL:24
  LDRB r1,[r0,#:INDEX:R6502_A]
  STR r2,[r0,#:INDEX:R6502_M_SHIFT]
  TST r8,#DFLAG
  BNE r6502isbstepD
  TEQ r2,r8,LSR #1   ;jdl** ARM c =6502 c
  BIC r8,r8,#NFLAG|VFLAG|ZFLAG|CFLAG
  RSCS r1,r2,r1,ROR #8
  ORRMI r8,r8,#NFLAG
  ORRVS r8,r8,#VFLAG
  ORRCS r8,r8,#CFLAG
  MOVS r1,r1,LSR#24 ;(a=(a>>24) jdl** also (z=(a=0))
  ORREQ r8,r8,#ZFLAG
  STRB r1,[r0,#:INDEX:R6502_A]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN
r6502isbstepD
  TEQ r2,r8,LSR #1   ;jdl** ARM c =6502 c
  ORR r2,r2,r2,ROR #24
  ORR r1,r1,r1,ROR #8
  AND r2,r2,#&F000000F
  AND r1,r1,#&F000000F
  MVN r2,r2
  BIC r8,r8,#NFLAG|VFLAG|ZFLAG|CFLAG
  ADCS r1,r1,r2
  ORRCS r8,r8,#CFLAG
  ORRMI r8,r8,#NFLAG
  ORRVS r8,r8,#VFLAG
  MOV r2,r1
  SUBCC r1,r1,#&60000000
  TST r1,#&80
  SUBNE r1,r1,#6
  AND r1,r1,#&F000000F
  TST r2,#&F000000F
  ORR r1,r1,r1,LSR #24
  ORREQ r8,r8,#ZFLAG
  STRB r1,[r0,#:INDEX:R6502_A]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

;// STORE STEPS
|r6502topushpstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r3,#R6502_IRQ_ENABLE
  LDR r6,[r0,#:INDEX:R6502_SP_CODE]
  BICNE r2,r8,#IFLAG
  STREQB r8,[r0,#:INDEX:R6502_M]
  STRNEB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_WRITE_RETURN

|r6502topushastep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_SP_CODE]
  LDRB r2,[r0,#:INDEX:R6502_A]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_WRITE_RETURN

|r6502loadzpgtostastep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ADD r6,r7,#1:SHL:16
  LDRB r2,[r0,#:INDEX:R6502_A]
  STR r6,[r0,#:INDEX:R6502_LAST_PC_CODE]
  LDR r6,[r0,#:INDEX:R6502_M_SHIFT]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502loadabstostastep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDRB r6,[r0,#:INDEX:R6502_M]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  ORR r6,r2,r6,LSL #24
  LDRB r2,[r0,#:INDEX:R6502_A]
  ORR r6,r6,#ADDRESSING_BASEFLAG
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502loadzpgxtostastep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  LDRB r2,[r0,#:INDEX:R6502_X]
  ADD r6,r6,r2,LSL #24
  LDRB r2,[r0,#:INDEX:R6502_A]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502fixindexedtostastep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDRB r2,[r0,#:INDEX:R6502_A]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502loadzpgtostxstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ADD r6,r7,#1:SHL:16
  LDRB r2,[r0,#:INDEX:R6502_X]
  STR r6,[r0,#:INDEX:R6502_LAST_PC_CODE]
  LDR r6,[r0,#:INDEX:R6502_M_SHIFT]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502loadabstostxstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDRB r6,[r0,#:INDEX:R6502_M]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  ORR r6,r2,r6,LSL #24
  LDRB r2,[r0,#:INDEX:R6502_X]
  ORR r6,r6,#ADDRESSING_BASEFLAG
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502loadzpgytostxstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  LDRB r2,[r0,#:INDEX:R6502_Y]
  ADD r6,r6,r2,LSL #24
  LDRB r2,[r0,#:INDEX:R6502_X]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502loadzpgtostystep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ADD r6,r7,#1:SHL:16
  LDRB r2,[r0,#:INDEX:R6502_Y]
  STR r6,[r0,#:INDEX:R6502_LAST_PC_CODE]
  LDR r6,[r0,#:INDEX:R6502_M_SHIFT]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502loadabstostystep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDRB r6,[r0,#:INDEX:R6502_M]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  ORR r6,r2,r6,LSL #24
  LDRB r2,[r0,#:INDEX:R6502_Y]
  ORR r6,r6,#ADDRESSING_BASEFLAG
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502loadzpgxtostystep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  LDRB r2,[r0,#:INDEX:R6502_X]
  ADD r6,r6,r2,LSL #24
  LDRB r2,[r0,#:INDEX:R6502_Y]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502loadzpgtosaxstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ADD r6,r7,#1:SHL:16
  LDRB r3,[r0,#:INDEX:R6502_A]
  LDRB r2,[r0,#:INDEX:R6502_X]
  STR r6,[r0,#:INDEX:R6502_LAST_PC_CODE]
  AND r2,r3,r2
  LDR r6,[r0,#:INDEX:R6502_M_SHIFT]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502loadzpgytosaxstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  LDRB r2,[r0,#:INDEX:R6502_Y]
  ADD r6,r6,r2,LSL #24
  LDRB r3,[r0,#:INDEX:R6502_A]
  LDRB r2,[r0,#:INDEX:R6502_X]
  AND r2,r3,r2
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_ZPG_WRITE_RETURN

|r6502loadabstosaxstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDRB r6,[r0,#:INDEX:R6502_M]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  LDRB r3,[r0,#:INDEX:R6502_A]
  ORR r6,r2,r6,LSL #24
  LDRB r2,[r0,#:INDEX:R6502_X]
  AND r2,r3,r2
  ORR r6,r6,#ADDRESSING_BASEFLAG
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502fixindexedtoaxastep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r3,[r0,#:INDEX:R6502_Y]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  ADD r2,r2,r3,LSL #16
  TST r2,#1:SHL:24
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  LDRB r2,[r0,#:INDEX:R6502_A]
  LDRB r3,[r0,#:INDEX:R6502_X]
  AND r2,r2,r3
  ADDEQ r6,r6,#1:SHL:24
  AND r2,r2,r6,LSR #24
  SUBEQ r6,r6,#1:SHL:24
  STRB r2,[r0,#:INDEX:R6502_M]
  BICNE r6,r6,#&FF000000
  ORRNE r6,r6,r2,LSL #24
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502fixindexedtoxasstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r3,[r0,#:INDEX:R6502_Y]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  ADD r2,r2,r3,LSL #16
  TST r2,#1:SHL:24
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  LDRB r2,[r0,#:INDEX:R6502_X]
  ADDEQ r6,r6,#1:SHL:24
  AND r2,r2,r6,LSR #24
  SUBEQ r6,r6,#1:SHL:24
  STRB r2,[r0,#:INDEX:R6502_M]
  BICNE r6,r6,#&FF000000
  ORRNE r6,r6,r2,LSL #24
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502fixindexedtosaystep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r3,[r0,#:INDEX:R6502_X]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  ADD r2,r2,r3,LSL #16
  TST r2,#1:SHL:24
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  LDRB r2,[r0,#:INDEX:R6502_Y]
  ADDEQ r6,r6,#1:SHL:24
  AND r2,r2,r6,LSR #24
  SUBEQ r6,r6,#1:SHL:24
  STRB r2,[r0,#:INDEX:R6502_M]
  BICNE r6,r6,#&FF000000
  ORRNE r6,r6,r2,LSL #24
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502fixindexedtotasstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r3,[r0,#:INDEX:R6502_Y]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  ADD r2,r2,r3,LSL #16
  TST r2,#1:SHL:24
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  LDRB r2,[r0,#:INDEX:R6502_A]
  LDRB r3,[r0,#:INDEX:R6502_X]
  AND r2,r2,r3
  STRB r2,[r0,#:INDEX:R6502_SP_CODE+3]
  ADDEQ r6,r6,#1:SHL:24
  AND r2,r2,r6,LSR #24
  SUBEQ r6,r6,#1:SHL:24
  STRB r2,[r0,#:INDEX:R6502_M]
  BICNE r6,r6,#&FF000000
  ORRNE r6,r6,r2,LSL #24
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_WRITE_RETURN

|r6502pushedstep|
  LDR r1,[r0,#:INDEX:R6502_SP_CODE]
  SUB r1,r1,#1:SHL:24
  STR r1,[r0,#:INDEX:R6502_SP_CODE]
  R6502_CYCLE_IMPLIED_INTERRUPT_CHECK_FETCH_RETURN

;// BRANCHES
|r6502bplstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#NFLAG
  ADD r6,r7,#2:SHL:16
  R6502_CYCLE_UPDATE_POP
  BEQ r6502bplstep2
  R6502_CYCLE_INTERRUPT_CHECK_FETCH_RETURN
r6502bplstep2
  LDRB r3,[r0,#:INDEX:R6502_M]
  STRB r3,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_READ_RETURN

|r6502bmistep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#NFLAG
  ADD r6,r7,#2:SHL:16
  R6502_CYCLE_UPDATE_POP
  BNE r6502bmistep2
  R6502_CYCLE_INTERRUPT_CHECK_FETCH_RETURN
r6502bmistep2
  LDRB r3,[r0,#:INDEX:R6502_M]
  STRB r3,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_READ_RETURN

|r6502bvcstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#VFLAG
  ADD r6,r7,#2:SHL:16
  R6502_CYCLE_UPDATE_POP
  BEQ r6502bvcstep2
  R6502_CYCLE_INTERRUPT_CHECK_FETCH_RETURN
r6502bvcstep2
  LDRB r3,[r0,#:INDEX:R6502_M]
  STRB r3,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_READ_RETURN

|r6502bvsstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#VFLAG
  ADD r6,r7,#2:SHL:16
  R6502_CYCLE_UPDATE_POP
  BNE r6502bvsstep2
  R6502_CYCLE_INTERRUPT_CHECK_FETCH_RETURN
r6502bvsstep2
  LDRB r3,[r0,#:INDEX:R6502_M]
  STRB r3,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_READ_RETURN

|r6502bccstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#CFLAG
  ADD r6,r7,#2:SHL:16
  R6502_CYCLE_UPDATE_POP
  BEQ r6502bccstep2
  R6502_CYCLE_INTERRUPT_CHECK_FETCH_RETURN
r6502bccstep2
  LDRB r3,[r0,#:INDEX:R6502_M]
  STRB r3,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_READ_RETURN

|r6502bcsstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#CFLAG
  ADD r6,r7,#2:SHL:16
  R6502_CYCLE_UPDATE_POP
  BNE r6502bcsstep2
  R6502_CYCLE_INTERRUPT_CHECK_FETCH_RETURN
r6502bcsstep2
  LDRB r3,[r0,#:INDEX:R6502_M]
  STRB r3,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_READ_RETURN

|r6502bnestep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#ZFLAG
  ADD r6,r7,#2:SHL:16
  R6502_CYCLE_UPDATE_POP
  BEQ r6502bnestep2
  R6502_CYCLE_INTERRUPT_CHECK_FETCH_RETURN
r6502bnestep2
  LDRB r3,[r0,#:INDEX:R6502_M]
  STRB r3,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_READ_RETURN

|r6502beqstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r8,#ZFLAG
  ADD r6,r7,#2:SHL:16
  R6502_CYCLE_UPDATE_POP
  BNE r6502beqstep2
  R6502_CYCLE_INTERRUPT_CHECK_FETCH_RETURN
r6502beqstep2
  LDRB r3,[r0,#:INDEX:R6502_M]
  STRB r3,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_READ_RETURN

|r6502branchtakenstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r3,[r0,#:INDEX:R6502_LATCH+2]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r3,#&80
  ADD r2,r7,#2:SHL:16
  ORRNE r3,r3,#&FF00
  ADD r6,r2,r3,LSL #16
  EOR r3,r2,r6
  ANDS r3,r3,#&FF000000
  BNE r6502branchtakenstep2
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_EARLY_INTERRUPT_CHECK_FETCH_RETURN
r6502branchtakenstep2
  STR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  EOR r6,r6,r3
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502fixbranchtakenstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_INTERRUPT_CHECK_FETCH_RETURN

;// JUMPS
|r6502latchjmpabsindlostep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  MOV r6,r6,ROR #24
  ADD r6,r6,#1:SHL:24
  LDRB r2,[r0,#:INDEX:R6502_M]
  MOV r6,r6,ROR #8
  STRB r2,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502loadpchstep|
  R6502_CYCLE_UPDATE_PUSH
  LDRB r6,[r0,#:INDEX:R6502_M]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  ORR r6,r2,r6,LSL #24
  ORR r6,r6,#ADDRESSING_BASEFLAG
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_INTERRUPT_CHECK_FETCH_RETURN

;// VECTORS AND SUBROUTINES
|r6502waitonresetstep|
  LDR r2,[r0,#:INDEX:R6502_LBREAK]
  TST r2,r2
  LDRB r2,[r0,#:INDEX:R6502_OLDRESET]
  BNE r6502waitonresetcontinuing
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  TST r2,r2
  [ !Optimise6502Links
  STR lr,[sp, #-4]!
  ]
  BNE r6502waitonresetstep2
  MOV r2,#1
  STRB r2,[r0,#:INDEX:R6502_OLDRESET]
  MOV lr,pc
  LDR pc,[r0,#:INDEX:R6502_RESETSTARTINGACTION]
  LDRB r2,[r0,#:INDEX:R6502_OLDRESET]
r6502waitonresetstep2
  MOV r2,#0
  STRB r2,[r0,#:INDEX:R6502_OLDRESET]
  MOV lr,pc
  LDR pc,[r0,#:INDEX:R6502_RESETCONTINUINGACTION]
  [ !Optimise6502Links
  LDR lr, [sp], #4
  ]
  ADD r6,r7,#1:SHL:16
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

r6502waitonresetcontinuing
  TST r2,r2
  BNE r6502waitonresetcontinuing2
  MOV r2,#1
  STRB r2,[r0,#:INDEX:R6502_OLDRESET]
  R6502_CYCLE_CALL_ACTION R6502_RESETSTARTINGACTION
r6502waitonresetcontinuing2
  R6502_CYCLE_RETURN

|r6502resetstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_SP_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_READ_RETURN

|r6502nooperandstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  MOV r6,r7
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502notpushedtonotpushstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_SP_CODE]
  SUB r6,r2,#1:SHL:24
  STR r6,[r0,#:INDEX:R6502_SP_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_READ_RETURN

|r6502breadcrumbnotpushedtoresetlostep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_SP_CODE]
  SUB r2,r2,#1:SHL:24
  STR r2,[r0,#:INDEX:R6502_SP_CODE]
  LDR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  MOV r6,#ADDRESSING_BASEFLAG
  BIC r3,r3,#R6502_IRQ_ENABLE
  STR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  LDR r3,[r0,#:INDEX:R6502_TRANSITION2]
  SUB r6,r6,#4:SHL:16
  STR r3,[r0,#:INDEX:R6502_TRANSITION1]
  LDR r2,[r0,#:INDEX:R6502_LBREAK]
  STR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  TST r2,r2
  MOVNE r3,#R6502_RESET_TRANSITION
  STRNE r3,[r0,#:INDEX:R6502_TRANSITION1]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_VECTOR_READ_RETURN

|r6502pushedtobrkpushpclstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_SP_CODE]
  SUB r6,r2,#1:SHL:24
  ADD r2,r7,#2:SHL:16
  STR r6,[r0,#:INDEX:R6502_SP_CODE]
  MOV r2,r2,LSR #16
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_WRITE_RETURN

|r6502pushedtopushpclstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_SP_CODE]
  SUB r6,r2,#1:SHL:24
  MOV r2,r7,LSR #16
  STR r6,[r0,#:INDEX:R6502_SP_CODE]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_WRITE_RETURN

|r6502pushedtopushpstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_SP_CODE]
  TST r3,#R6502_IRQ_ENABLE
  SUB r6,r2,#1:SHL:24
  BICNE r2,r8,#IFLAG
  STR r6,[r0,#:INDEX:R6502_SP_CODE]
  STREQB r8,[r0,#:INDEX:R6502_M]
  STRNEB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_WRITE_RETURN

|r6502pushedtopushpwithoutbstep|
  R6502_CYCLE_UPDATE_PUSH
  LDR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_SP_CODE]
  TST r3,#R6502_IRQ_ENABLE
  SUB r6,r2,#1:SHL:24
  BICEQ r2,r8,#BFLAG
  BICNE r2,r8,#BFLAG|IFLAG
  STR r6,[r0,#:INDEX:R6502_SP_CODE]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_WRITE_RETURN

|r6502breadcrumbpushedtointerruptlostep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_SP_CODE]
  SUB r2,r2,#1:SHL:24
  STR r2,[r0,#:INDEX:R6502_SP_CODE]
  MOV r6,#ADDRESSING_BASEFLAG
  LDR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  TST r3,#R6502_NMI_ENABLE
  TSTNE r3,#R6502_NMI
  BIC r3,r3,#R6502_IRQ_ENABLE
  BICNE r3,r3,#R6502_NMI_ENABLE
  STR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  SUBNE r6,r6,#6:SHL:16
  SUBEQ r6,r6,#2:SHL:16
  STR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_VECTOR_READ_RETURN

|r6502latchveclostep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_ADDRESS_CODE]
  ADD r6,r6,#1:SHL:16
  LDRB r2,[r0,#:INDEX:R6502_M]
  STRB r2,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_VECTOR_READ_RETURN

|r6502tobrkpushpchstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ADD r2,r7,#2:SHL:16
  LDR r6,[r0,#:INDEX:R6502_SP_CODE]
  MOV r2,r2,LSR #24
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_WRITE_RETURN

|r6502topushpchstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  MOV r2,r7,LSR #24
  LDR r6,[r0,#:INDEX:R6502_SP_CODE]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_WRITE_RETURN

|r6502latchabslobeforepushstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  ADD r6,r7,#2:SHL:16
  LDRB r3,[r0,#:INDEX:R6502_M]
  STR r6,[r0,#:INDEX:R6502_LAST_PC_CODE]
  STRB r3,[r0,#:INDEX:R6502_LATCH+2]
  LDR r6,[r0,#:INDEX:R6502_SP_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_READ_RETURN

|r6502tojsrpushpchstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r6,[r0,#:INDEX:R6502_SP_CODE]
  LDRB r2,[r0,#:INDEX:R6502_LAST_PC_CODE+3]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_WRITE_RETURN

|r6502pushedtojsrpushpclstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_SP_CODE]
  SUB r6,r2,#1:SHL:24
  STR r6,[r0,#:INDEX:R6502_SP_CODE]
  LDRB r2,[r0,#:INDEX:R6502_LAST_PC_CODE+2]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_WRITE_RETURN

|r6502pushedtoloadpchstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_SP_CODE]
  SUB r2,r2,#1:SHL:24
  STR r2,[r0,#:INDEX:R6502_SP_CODE]
  LDR r6,[r0,#:INDEX:R6502_LAST_PC_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502pulledptopullstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_SP_CODE]
  LDRB r8,[r0,#:INDEX:R6502_M]
  ADD r6,r2,#1:SHL:24
  LDR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  TST r8,#IFLAG
  STR r6,[r0,#:INDEX:R6502_SP_CODE]
  BICNE r3,r3,#R6502_IRQ_ENABLE
  ORREQ r3,r3,#R6502_IRQ_ENABLE
  ORR r8,r8,#UFLAG|BFLAG|IFLAG
  STR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_READ_RETURN

|r6502pulledpclstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r0,#:INDEX:R6502_SP_CODE]
  ADD r6,r2,#1:SHL:24
  STR r6,[r0,#:INDEX:R6502_SP_CODE]
  LDRB r2,[r0,#:INDEX:R6502_M]
  STRB r2,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_STACK_READ_RETURN

|r6502loadpchtoincrementstep|
  R6502_CYCLE_UPDATE_PUSH
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDRB r6,[r0,#:INDEX:R6502_M]
  LDR r2,[r0,#:INDEX:R6502_LATCH]
  ORR r6,r2,r6,LSL #24
  ORR r6,r6,#ADDRESSING_BASEFLAG
  STR r6,[r0,#:INDEX:R6502_LAST_PC_CODE]
  R6502_CYCLE_UPDATE_POP
  R6502_CYCLE_READ_RETURN

|r6502midstretchstep|
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  R6502_CYCLE_STRETCH_RETURN

|r6502stretchedreadstep|
  LDR r3,[r0,#:INDEX:R6502_STRETCHED_CPU_STATE]
  LDR r1,[r0,#:INDEX:R6502_STRETCHED_ADDRESS_CODE]
  STR r3,[r0,#:INDEX:R6502_CPU_STATE]
  R6502_CYCLE_READSPECIAL
  R6502_CYCLE_RETURN

|r6502stretcheddiscardstep|
  LDR r3,[r0,#:INDEX:R6502_STRETCHED_CPU_STATE]
  LDR r1,[r0,#:INDEX:R6502_STRETCHED_ADDRESS_CODE]
  LDRB r2,[r0,#:INDEX:R6502_M]
  STR r3,[r0,#:INDEX:R6502_CPU_STATE]
  STRB r2,[r0,#:INDEX:R6502_LATCH+2]
  R6502_CYCLE_READSPECIAL
  LDRB r2,[r0,#:INDEX:R6502_LATCH+2]
  STRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_RETURN

|r6502stretchedwritestep|
  LDR r3,[r0,#:INDEX:R6502_STRETCHED_CPU_STATE]
  LDR r1,[r0,#:INDEX:R6502_STRETCHED_ADDRESS_CODE]
  STR r3,[r0,#:INDEX:R6502_CPU_STATE]
  LDRB r2,[r0,#:INDEX:R6502_M]
  R6502_CYCLE_WRITESPECIAL
  R6502_CYCLE_RETURN

r6502opcodefetchdoreset
  ADD r1,r0,#:INDEX:R6502_SEQUENCES
  LDR r1,[r1,#R6502_RESET_SEQUENCE:SHL:2]
  R6502_OPCODE_RETURN

r6502opcodefetchdointerrupt
  LDR r1,[r1,#R6502_INTERRUPT_SEQUENCE:SHL:2]
  R6502_OPCODE_RETURN

r6502opcodefetchdoyield
  STR r1,[r0,#:INDEX:R6502_EXECUTE_CPU_STATE]
  ADD r1,r0,#:INDEX:R6502_SEQUENCES
  LDR r1,[r1,#R6502_YIELD_SEQUENCE:SHL:2]
  R6502_OPCODE_RETURN

  MACRO
  OPCODELOGFETCH
  STMFD sp!,{r4,lr}
  CMP r1,r6
  MOVEQ r1,sp
  STR r7,[r0,#:INDEX:R6502_SYNC_PC_CODE]
  BL logfetch
  LDMFD sp!,{r4,lr}
  MEND

|r6502opcodefetchreturn|
  OPCODELOGFETCH
  LDR r3,[r0,#:INDEX:R6502_TRANSITION1]
  CMP r3,#R6502_RESET_TRANSITION
  BEQ r6502opcodefetchdoreset
  ADD r1,r0,#:INDEX:R6502_SEQUENCES
  LDR r1,[r1,r4,LSL #2]
  CMP r3,#R6502_YIELD_TRANSITION
  BEQ r6502opcodefetchdoyield
  R6502_OPCODE_RETURN

|r6502opcodeearlyinterruptfetchreturn|
  OPCODELOGFETCH
  LDR r3,[r0,#:INDEX:R6502_TRANSITION1]
  LDR r1,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  CMP r3,#R6502_RESET_TRANSITION
  AND r1,r1,r1,LSR #6
  BEQ r6502opcodefetchdoreset
  TST r1,#R6502_NMI_IRQ_ENABLE:SHL:16
  ADD r1,r0,#:INDEX:R6502_SEQUENCES
  BNE r6502opcodefetchdointerrupt
  LDR r1,[r1,r4,LSL #2]
  CMP r3,#R6502_YIELD_TRANSITION
  BEQ r6502opcodefetchdoyield
  R6502_OPCODE_RETURN

|r6502opcodeinterruptfetchreturn|
  OPCODELOGFETCH
  LDR r3,[r0,#:INDEX:R6502_TRANSITION1]
  LDR r1,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  CMP r3,#R6502_RESET_TRANSITION
  AND r1,r1,r1,LSR #6
  BEQ r6502opcodefetchdoreset
  TST r1,#R6502_NMI_IRQ_ENABLE:SHL:12
  ADD r1,r0,#:INDEX:R6502_SEQUENCES
  BNE r6502opcodefetchdointerrupt
  LDR r1,[r1,r4,LSL #2]
  CMP r3,#R6502_YIELD_TRANSITION
  BEQ r6502opcodefetchdoyield
  R6502_OPCODE_RETURN

|r6502startyield|
  LDR r1,[r0,#:INDEX:R6502_TRANSITION1]
  MOV r3,#R6502_YIELD_TRANSITION
  CMP r1,#R6502_REGULAR_TRANSITION
  STR r3,[r0,#:INDEX:R6502_TRANSITION2]
  MOVNE pc,lr
  STR r3,[r0,#:INDEX:R6502_TRANSITION1]
  LDR r1,[r0,#:INDEX:R6502_LBREAK]
  TST r1,r1
  MOVNE r3,#R6502_RESET_TRANSITION
  STRNE r3,[r0,#:INDEX:R6502_TRANSITION1]
  MOV pc,lr

|r6502yieldstep|
  [ Optimise6502Links
  LDR pc,[r0,#:INDEX:R6502_YIELDLINK]
  |
  MOV pc,lr
  ]


;Data Area

;  AREA    |C$$data|, DATA

  END
