;>hosts.s
;
; BeebIt - BBC Micro Model B Emulator
;
; (C) Copyright Michael J Foot, 1998-2024
;
; Email: <mjfoot.nz@gmail.com>
;
; Fast ROM paging contributed by Crispian Daniels in 2024
;
; Email: <convertedgames@3insdale.me.uk>
;

  GET h.6502zmaps

  GET h.6502cmaps

  GET h.6502cpus

  GET h.hostmaps

  GET h.hosts

; Use the GET directive to include register definitions as if typed here

  GET h.RegNames

; Use the GET directive to include a list of SWI names as if typed here

  GET h.SWInames

; Area name C$$code advisable as wanted to link with C output

  AREA    |C$$code|, CODE, READONLY

; Import global symbols

  IMPORT |systemviaatzerocycles|
  IMPORT |userviaatzerocycles|
  IMPORT |i8271poll|
  IMPORT |w1770poll|
  IMPORT |adcpoll|
  IMPORT |aciapoll|
  IMPORT |videoatzerocycles|
  IMPORT |keyscanf1p0c|
  IMPORT |keyscanf1p0C|
  IMPORT |keyscanf1p0i|
  IMPORT |keyscanf1p0I|
  IMPORT |keyscanf1|
  IMPORT |keyscanb1|
  IMPORT |keyscanf1p1c|
  IMPORT |keyscanf1p1C|
  IMPORT |keyscanf1p1i|
  IMPORT |keyscanf1p1I|
  IMPORT |keyscanf2p0c|
  IMPORT |keyscanf2p0C|
  IMPORT |keyscanp0c|
  IMPORT |keyscanp0C|
  IMPORT |keyscanp0i|
  IMPORT |keyscanp0I|
  IMPORT |keyscanf2p1c|
  IMPORT |keyscanf2p1C|
  IMPORT |keyscanp1c|
  IMPORT |keyscanp1C|
  IMPORT |keyscanp1i|
  IMPORT |keyscanp1I|
  IMPORT |keyscanf2p2c|
  IMPORT |keyscanf2p2C|
  IMPORT |keyscanp2c|
  IMPORT |keyscanp2C|
  IMPORT |keyscanp2i|
  IMPORT |keyscanp2I|
  IMPORT |keyscanf3p1cp0c|
  IMPORT |keyscanf3p1Cp0C|
  IMPORT |keyscanf3p0c|
  IMPORT |keyscanf3p0C|
  IMPORT |keyscanb1p0c|
  IMPORT |keyscanb1p0C|
  IMPORT |keyscanb1p0i|
  IMPORT |keyscanb1p0I|
  IMPORT |keyscanf3p2cp0c|
  IMPORT |keyscanf3p2Cp0C|
  IMPORT |keyscanf1p2c|
  IMPORT |keyscanf1p2C|
  IMPORT |keyscanf1p2i|
  IMPORT |keyscanf1p2I|
  IMPORT |keyscanf3p1c|
  IMPORT |keyscanf3p1C|
  IMPORT |keyscanb1p1c|
  IMPORT |keyscanb1p1C|
  IMPORT |keyscanb1p1i|
  IMPORT |keyscanb1p1I|
  IMPORT |keyscanf3p3cp1c|
  IMPORT |keyscanf3p3Cp1C|
  IMPORT |keyscanf1p3c|
  IMPORT |keyscanf1p3C|
  IMPORT |keyscanf1p3i|
  IMPORT |keyscanf1p3I|
  IMPORT |keyscanf3p2c|
  IMPORT |keyscanf3p2C|
  IMPORT |keyscanb1p2c|
  IMPORT |keyscanb1p2C|
  IMPORT |keyscanb1p2i|
  IMPORT |keyscanb1p2I|
  IMPORT |keyscanf4p2cp0c|
  IMPORT |keyscanf4p2Cp0C|
  IMPORT |keyscanf4p1cp0c|
  IMPORT |keyscanf4p1Cp0C|
  IMPORT |keyscanf4p3cp1c|
  IMPORT |keyscanf4p3Cp1C|
  IMPORT |keyscanp3c|
  IMPORT |keyscanp3C|
  IMPORT |keyscanp3i|
  IMPORT |keyscanp3I|
  IMPORT |keyscanf4p4cp2c|
  IMPORT |keyscanf4p4Cp2C|
  IMPORT |keyscanp4c|
  IMPORT |keyscanp4C|
  IMPORT |keyscanp4i|
  IMPORT |keyscanp4I|
  IMPORT |keyscanf5p3cp1cp0c|
  IMPORT |keyscanf5p3Cp1Cp0C|
  IMPORT |keyscanf5p2cp0c|
  IMPORT |keyscanf5p2Cp0C|
  IMPORT |keyscanf5p4cp2cp0c|
  IMPORT |keyscanf5p4Cp2Cp0C|
  IMPORT |keyscanf1p4c|
  IMPORT |keyscanf1p4C|
  IMPORT |keyscanf1p4i|
  IMPORT |keyscanf1p4I|
  IMPORT |keyscanf5p3cp1c|
  IMPORT |keyscanf5p3Cp1C|
  IMPORT |keyscanb1p3c|
  IMPORT |keyscanb1p3C|
  IMPORT |keyscanb1p3i|
  IMPORT |keyscanb1p3I|
  IMPORT |keyscanf5p5cp3cp1c|
  IMPORT |keyscanf5p5Cp3Cp1C|
  IMPORT |keyscanf1p5c|
  IMPORT |keyscanf1p5C|
  IMPORT |keyscanf1p5i|
  IMPORT |keyscanf1p5I|
  IMPORT |keyscanf5p4cp2c|
  IMPORT |keyscanf5p4Cp2C|
  IMPORT |keyscanb1p4c|
  IMPORT |keyscanb1p4C|
  IMPORT |keyscanb1p4i|
  IMPORT |keyscanb1p4I|
  IMPORT |keyscanf6p4cp2cp0c|
  IMPORT |keyscanf6p4Cp2Cp0C|
  IMPORT |keyscanf6p3cp1cp0c|
  IMPORT |keyscanf6p3Cp1Cp0C|
  IMPORT |keyscanf6p5cp3cp1c|
  IMPORT |keyscanf6p5Cp3Cp1C|
  IMPORT |keyscanp5c|
  IMPORT |keyscanp5C|
  IMPORT |keyscanp5i|
  IMPORT |keyscanp5I|
  IMPORT |keyscanf6p6cp4cp2c|
  IMPORT |keyscanf6p6Cp4Cp2C|
  IMPORT |keyscanp6c|
  IMPORT |keyscanp6C|
  IMPORT |keyscanp6i|
  IMPORT |keyscanp6I|
  IMPORT |keyscanf7p5cp3cp1cp0c|
  IMPORT |keyscanf7p5Cp3Cp1Cp0C|
  IMPORT |keyscanf7p4cp2cp0c|
  IMPORT |keyscanf7p4Cp2Cp0C|
  IMPORT |keyscanf7p6cp4cp2cp0c|
  IMPORT |keyscanf7p6Cp4Cp2Cp0C|
  IMPORT |keyscanf1p6c|
  IMPORT |keyscanf1p6C|
  IMPORT |keyscanf1p6i|
  IMPORT |keyscanf1p6I|
  IMPORT |keyscanf7p5cp3cp1c|
  IMPORT |keyscanf7p5Cp3Cp1C|
  IMPORT |keyscanb1p5c|
  IMPORT |keyscanb1p5C|
  IMPORT |keyscanb1p5i|
  IMPORT |keyscanb1p5I|
  IMPORT |keyscanf8p6cp4cp2cp0c|
  IMPORT |keyscanf8p6Cp4Cp2Cp0C|
  IMPORT |keyscanf8p5cp3cp1cp0c|
  IMPORT |keyscanf8p5Cp3Cp1Cp0C|

; Export global symbols

  EXPORT |hostmap|

  EXPORT |host_r6502address0000|
  EXPORT |host_r6502address3000|
  EXPORT |host_r6502addressbp3000_ram|
  EXPORT |host_r6502addressbp3000_ramram|
  EXPORT |host_r6502addressm3000_x|
  EXPORT |host_r6502addressm3000_e|
  EXPORT |host_r6502addressbp8000_ram|
  EXPORT |host_r6502addressm8000_ram|
  EXPORT |host_r6502addressmC000_y|
  EXPORT |host_r6502addressFE00_fast|
  EXPORT |host_r6502addressFE00_slow|

  EXPORT |host_r6502read8000_0|
  EXPORT |host_r6502read8000_1|
  EXPORT |host_r6502read8000_2|
  EXPORT |host_r6502read8000_3|
  EXPORT |host_r6502read8000_4|
  EXPORT |host_r6502read8000_5|
  EXPORT |host_r6502read8000_6|
  EXPORT |host_r6502read8000_7|
  EXPORT |host_r6502read8000_8|
  EXPORT |host_r6502read8000_9|
  EXPORT |host_r6502read8000_A|
  EXPORT |host_r6502read8000_B|
  EXPORT |host_r6502read8000_C|
  EXPORT |host_r6502read8000_D|
  EXPORT |host_r6502read8000_E|
  EXPORT |host_r6502read8000_F|
  EXPORT |host_r6502readC000|
  EXPORT |host_r6502readF000|
  EXPORT |host_r6502readmFC00|
  EXPORT |host_r6502modify8000_0|
  EXPORT |host_r6502modify8000_1|
  EXPORT |host_r6502modify8000_2|
  EXPORT |host_r6502modify8000_3|
  EXPORT |host_r6502modify8000_4|
  EXPORT |host_r6502modify8000_5|
  EXPORT |host_r6502modify8000_6|
  EXPORT |host_r6502modify8000_7|
  EXPORT |host_r6502modify8000_8|
  EXPORT |host_r6502modify8000_9|
  EXPORT |host_r6502modify8000_A|
  EXPORT |host_r6502modify8000_B|
  EXPORT |host_r6502modify8000_C|
  EXPORT |host_r6502modify8000_D|
  EXPORT |host_r6502modify8000_E|
  EXPORT |host_r6502modify8000_F|
  EXPORT |host_r6502modifyC000|
  EXPORT |host_r6502modifyF000|
  EXPORT |host_r6502modifymFC00|

  EXPORT |host_r6502readfred|
  EXPORT |host_r6502readjim|
  EXPORT |host_r6502writefred|
  EXPORT |host_r6502writejim|
  EXPORT |host_r6502readmfred|
  EXPORT |host_r6502readmjim|
  EXPORT |host_r6502writemfred|
  EXPORT |host_r6502writemjim|

  EXPORT |host_r6502cycleroutines|

  EXPORT |host_r6502readspecial|
  EXPORT |host_r6502writespecial|

  ;EXPORT |hostadvancetimers|
  ;EXPORT |hostexecute|

  ASSERT :INDEX:HOST_M_SHIFT == :INDEX:R6502ZONE_M_SHIFT
  ASSERT :INDEX:HOST_M == :INDEX:R6502ZONE_M

  ASSERT :INDEX:HOST_AC == :INDEX:R6502ZONE_AC
  ASSERT :INDEX:HOST_BC == :INDEX:R6502ZONE_BC
  ASSERT :INDEX:HOST_CC == :INDEX:R6502ZONE_CC
  ASSERT :INDEX:HOST_DC == :INDEX:R6502ZONE_DC
  ASSERT :INDEX:HOST_EC == :INDEX:R6502ZONE_EC

host_r6502address0000
host_r6502address3000
host_r6502readC000
  ADD r3,r0,#:INDEX:HOST_MEMORY
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502addressbp3000_ram
  ADD r3,r7,#&20000000
  CMP r3,#&E0000000
  ADDLO r3,r0,#:INDEX:HOST_MEMORY
  ADDHS r3,r0,#:INDEX:HOST_SHADOW
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502addressbp3000_ramram
  ADD r3,r7,#&50000000
  CMP r3,#&F0000000
  BHS host_r6502addressbp3000_ramram2
  ADD r3,r3,#&D0000000
  CMP r3,#&E0000000
  ADDLO r3,r0,#:INDEX:HOST_MEMORY
host_r6502addressbp3000_ramram2
  ADDHS r3,r0,#:INDEX:HOST_SHADOW
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502addressm3000_x
  ADD r3,r0,#:INDEX:HOST_SHADOW
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502addressm3000_e
  ADD r3,r7,#&20000000
  CMP r3,#&E0000000
  ADDLO r3,r0,#:INDEX:HOST_MEMORY
  ADDHS r3,r0,#:INDEX:HOST_SHADOW
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502addressbp8000_ram
host_r6502addressm8000_ram
  ADD r3,r0,#:INDEX:HOST_SHADOW-&8000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502addressmC000_y
  ADD r3,r0,#:INDEX:HOST_SHADOW-&B000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502addressFE00_slow
  LDR r12,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_ODD]
  LDR r3,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_TOGO]
  EOR r3,r3,r12
  LDR r12,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_ORIGINAL]
  EOR r3,r3,r12
  TST r3,#1
  HOST_ADDRESSING_RETURN_STRETCHSPECIAL

host_r6502addressFE00_fast
  HOST_ADDRESSING_RETURN_SPECIAL

host_r6502read8000_0
  ADD r3,r0,#:INDEX:HOST_ROMS-&8000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502read8000_1
  ADD r3,r0,#:INDEX:HOST_ROMS-&4000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502read8000_2
  ADD r3,r0,#:INDEX:HOST_ROMS
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502read8000_3
  ADD r3,r0,#:INDEX:HOST_ROMS+&4000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502read8000_4
  ADD r3,r0,#:INDEX:HOST_ROMS+&8000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502read8000_5
  ADD r3,r0,#:INDEX:HOST_ROMS+&C000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502read8000_6
  ADD r3,r0,#:INDEX:HOST_ROMS+&10000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502read8000_7
  ADD r3,r0,#:INDEX:HOST_ROMS+&14000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502read8000_8
  ADD r3,r0,#:INDEX:HOST_ROMS+&18000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502read8000_9
  ADD r3,r0,#:INDEX:HOST_ROMS+&1C000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502read8000_A
  ADD r3,r0,#:INDEX:HOST_ROMS+&20000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502read8000_B
  ADD r3,r0,#:INDEX:HOST_ROMS+&24000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502read8000_C
  ADD r3,r0,#:INDEX:HOST_ROMS+&28000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502read8000_D
  ADD r3,r0,#:INDEX:HOST_ROMS+&2C000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502read8000_E
  ADD r3,r0,#:INDEX:HOST_ROMS+&30000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502read8000_F
  ADD r3,r0,#:INDEX:HOST_ROMS+&34000
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502readF000
  CMP r6,#&FC000000
  SUBHS r3,r0,#(&FC00:SHL:2)-:INDEX:HOST_READHIGH
  LDRHS pc,[r3,r6,LSR #14]
  ADD r3,r0,#:INDEX:HOST_MEMORY
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502readmFC00
  LDR pc,[r0,#:INDEX:HOST_READMFC00]

host_r6502modify8000_0
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE]
  ADD r3,r0,#:INDEX:HOST_ROMS-&8000
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modify8000_1
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE+1]
  ADD r3,r0,#:INDEX:HOST_ROMS-&4000
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modify8000_2
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE+2]
  ADD r3,r0,#:INDEX:HOST_ROMS
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modify8000_3
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE+3]
  ADD r3,r0,#:INDEX:HOST_ROMS+&4000
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modify8000_4
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE+4]
  ADD r3,r0,#:INDEX:HOST_ROMS+&8000
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modify8000_5
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE+5]
  ADD r3,r0,#:INDEX:HOST_ROMS+&C000
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modify8000_6
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE+6]
  ADD r3,r0,#:INDEX:HOST_ROMS+&10000
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modify8000_7
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE+7]
  ADD r3,r0,#:INDEX:HOST_ROMS+&14000
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modify8000_8
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE+8]
  ADD r3,r0,#:INDEX:HOST_ROMS+&18000
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modify8000_9
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE+9]
  ADD r3,r0,#:INDEX:HOST_ROMS+&1C000
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modify8000_A
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE+10]
  ADD r3,r0,#:INDEX:HOST_ROMS+&20000
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modify8000_B
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE+11]
  ADD r3,r0,#:INDEX:HOST_ROMS+&24000
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modify8000_C
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE+12]
  ADD r3,r0,#:INDEX:HOST_ROMS+&28000
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modify8000_D
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE+13]
  ADD r3,r0,#:INDEX:HOST_ROMS+&2C000
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modify8000_E
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE+14]
  ADD r3,r0,#:INDEX:HOST_ROMS+&30000
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modify8000_F
  LDRB r12,[r0,#:INDEX:HOST_ROMWRITABLE+15]
  ADD r3,r0,#:INDEX:HOST_ROMS+&34000
  TST r12,r12
  ADD r1,r3,r6,LSR #16
  HOST_ADDRESSING_RETURN_MAPPEDNE
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modifyC000
  ADD r3,r0,#:INDEX:HOST_MEMORY
  ADD r1,r3,r6,LSR #16
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modifyF000
  CMP r6,#&FC000000
  SUBHS r3,r0,#(&FC00:SHL:2)-:INDEX:HOST_MODIFYHIGH
  LDRHS pc,[r3,r6,LSR #14]
  ADD r3,r0,#:INDEX:HOST_MEMORY
  ADD r1,r3,r6,LSR #16
  LDRB r3,[r1]
  ADD r1,r0,#:INDEX:R6502_COPIEDVALUE
  STRB r3,[r0,#:INDEX:R6502_COPIEDVALUE]
  HOST_ADDRESSING_RETURN_MAPPED

host_r6502modifymFC00
  LDR pc,[r0,#:INDEX:HOST_MODIFYMFC00]

host_r6502readmfred
  LDRB r3,[r0,#:INDEX:HOST_ACCCON]
  TST r3,#&60
  MOVEQ r2,#0
  MOVEQ pc,lr
host_r6502readfred
  MOV r2,#0 ; unimplemented
  STR r0,[sp, #-4]!
  MOV r1,r1,LSR #16
  MOV r2,#&FE
  MOV r0,#&92 ; (146) read FRED
  AND r1,r1,#255 ; low 8 bits in R1
  SWI XOS_Byte ; may return V
  LDR r0, [sp], #4
  STRB r2,[r0,#:INDEX:HOST_M]
  MOV pc,lr

host_r6502readmjim
  LDRB r3,[r0,#:INDEX:HOST_ACCCON]
  TST r3,#&60
  MOVEQ r2,#0
  MOVEQ pc,lr
host_r6502readjim
  MOV r2,#0 ; unimplemented
  STR r0,[sp, #-4]!
  MOV r1,r1,LSR #16
  MOV r2,#&FE
  MOV r0,#&94 ; (148) read JIM
  AND r1,r1,#255 ; low 8 bits in R1
  SWI XOS_Byte ; may return V
  LDR r0, [sp], #4
  STRB r2,[r0,#:INDEX:HOST_M]
  MOV pc,lr

host_r6502writemfred
  LDRB r3,[r0,#:INDEX:HOST_ACCCON]
  TST r3,#&60
  MOVEQ pc,lr
host_r6502writefred
  STR r0,[sp, #-4]!
  MOV r1,r1,LSR #16
  MOV r0,#&93 ; (147) write FRED
  AND r1,r1,#255 ; low 8 bits in R1
  SWI XOS_Byte ; may return V
  LDR r0, [sp], #4
  MOV pc,lr

host_r6502writemjim
  LDRB r3,[r0,#:INDEX:HOST_ACCCON]
  TST r3,#&60
  MOVEQ pc,lr
host_r6502writejim
  STR r0,[sp, #-4]!
  MOV r1,r1,LSR #16
  MOV r0,#&95 ; (149) write JIM
  AND r1,r1,#255 ; low 8 bits in R1
  SWI XOS_Byte ; may return V
  LDR r0, [sp], #4
  MOV pc,lr

|host_r6502cycleroutines|
  DCD 0,host_r6502cycle1,host_r6502cycle2,host_r6502cycle3
  DCD host_r6502cycle4,host_r6502cycle5,host_r6502cycle6,0
  DCD host_r6502cycle0s1,host_r6502cycle1s1,host_r6502cycle2s1,host_r6502cycle3s1
  DCD host_r6502cycle4s1,host_r6502cycle5s1,host_r6502cycle6s1,0
  DCD host_r6502cycle0s2,host_r6502cycle1s2,host_r6502cycle2s2,host_r6502cycle3s2
  DCD host_r6502cycle4s2,host_r6502cycle5s2,host_r6502cycle6s2,0

  MACRO
  SHIFTINTERRUPTQUEUE $ra,$rb,$shift
  IF $shift==1
  ORR $ra,$ra,$rb,LSL #4
  ELIF $shift==2
  ORR $ra,$ra,$ra,LSL #4
  ORR $ra,$ra,$rb,LSL #8
  ELIF $shift==3
  ORR $ra,$ra,$ra,LSL #4
  ORR $ra,$ra,$ra,LSL #4
  ORR $ra,$ra,$rb,LSL #12
  ELIF $shift==4
  ORR $ra,$ra,$ra,LSL #4
  ORR $ra,$ra,$ra,LSL #8
  ORR $ra,$ra,$rb,LSL #16
  ELIF $shift==5
  ORR $ra,$ra,$ra,LSL #4
  ORR $ra,$ra,$ra,LSL #8
  ORR $ra,$ra,$ra,LSL #4
  ORR $ra,$ra,$rb,LSL #20
  ELIF $shift==6
  ORR $ra,$ra,$ra,LSL #4
  ORR $ra,$ra,$ra,LSL #8
  ORR $ra,$ra,$ra,LSL #8
  ORR $ra,$ra,$rb,LSL #24
  ELIF $shift==7
  ORR $ra,$ra,$ra,LSL #4
  ORR $ra,$ra,$ra,LSL #8
  ORR $rb,$ra,$ra,LSL #16
  ENDIF
  MEND

  MACRO
  TICK1SCAN1RETURN $shift,$routines
  [ $shift==0
  LDR r3,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_TOGO]
  |
  LDR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  TST r3,#R6502_NMI
  AND r2,r3,#&0F
  ORREQ r2,r2,#R6502_NMI_ENABLE
  SHIFTINTERRUPTQUEUE r2,r3,$shift
  LDR r3,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_TOGO]
  STR r2,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  ]
  LDR r1,[r0,#:INDEX:HOST_KEYSCANSTATE]
  SUBS r3,r3,#1
  LDR r2,[r0,#:INDEX:HOST_KEYCOLUMNFLAGS]
  STR r3,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_TOGO]
  STREQ lr,[sp, #-4]!
  ADREQ lr,firstadvancetimersreturn
  MOV r2,r2,ROR r1
  ADR r3,$routines
  ORR r2,r2,r2,LSR #1
  LDR pc,[r3,r1,LSR #26]
  MEND

  MACRO
  TICKNSCANMULTIPLEBRANCH $n,$shift,$routines,$advancetimersrtn
  LDR r3,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_TOGO]
  LDR r1,[r0,#:INDEX:HOST_KEYSCANSTATE]
  SUBS r3,r3,#$n
  BHI %F1
  ADR r2,%F2
  STR lr,[sp, #-4]!
  LDR pc,[r2,r3,LSL #2]
0
  ADR lr,$advancetimersrtn
1
  [ $shift==0
  STR r3,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_TOGO]
  |
  LDR r2,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  TST r2,#R6502_NMI
  STR r3,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_TOGO]
  AND r3,r2,#&0F
  ORREQ r3,r3,#R6502_NMI_ENABLE
  SHIFTINTERRUPTQUEUE r3,r2,$shift
  ]
  LDR r2,[r0,#:INDEX:HOST_KEYCOLUMNFLAGS]
  [ $shift>0
  STR r3,[r0,#:INDEX:R6502_INTERRUPTQUEUE]
  ]
  MOV r2,r2,ROR r1
  ADR r3,$routines
  ORR r2,r2,r2,LSR #1
  LDR pc,[r3,r1,LSR #26]
  MEND

  MACRO
  TICKNSCANMULTIPLEENDOFTABLE
2
  DCD %B0
  MEND

  MACRO
  TICK2SCAN1BRANCH $shift,$routines,$split
  TICKNSCANMULTIPLEBRANCH 2,$shift,$routines,firstadvancetimersreturn
  DCD $split
  TICKNSCANMULTIPLEENDOFTABLE
  MEND

  MACRO
  CYCLESPLIT $a,$b
  BL $a
  LDR lr, [sp], #4
  B $b
  MEND

host_r6502cycle0s1routines
  DCD keyscanf1p0c, keyscanf1p0C, keyscanf1p0c, keyscanf1p0C
  DCD keyscanf1p0c, keyscanf1p0C, keyscanf1p0i, keyscanf1p0I
  DCD keyscanf1, keyscanf1, keyscanb1, keyscanb1
  DCD keyscanf1, keyscanf1, keyscanb1, keyscanb1

host_r6502cycle1routines
  DCD keyscanf1p1c, keyscanf1p1C, keyscanf1p1c, keyscanf1p1C
  DCD keyscanf1p1c, keyscanf1p1C, keyscanf1p1i, keyscanf1p1I
  DCD keyscanf1, keyscanf1, keyscanb1, keyscanb1
  DCD keyscanf1, keyscanf1, keyscanb1, keyscanb1

host_r6502cycle0s1
  TICK1SCAN1RETURN 0,host_r6502cycle0s1routines

host_r6502cycle1
  TICK1SCAN1RETURN 1,host_r6502cycle1routines

firstadvancetimersreturn
  LDR lr, [sp], #4
  B hostadvancetimers

host_r6502cycle0s2routines
  DCD keyscanf2p0c, keyscanf2p0C, keyscanp0c, keyscanp0C
  DCD keyscanf2p0c, keyscanf2p0C, keyscanp0i, keyscanp0I
  DCD keyscanf2p0c, keyscanf2p0C, keyscanp0c, keyscanp0C
  DCD keyscanf2p0c, keyscanf2p0C, keyscanp0i, keyscanp0I

host_r6502cycle1s1routines
  DCD keyscanf2p1c, keyscanf2p1C, keyscanp1c, keyscanp1C
  DCD keyscanf2p1c, keyscanf2p1C, keyscanp1i, keyscanp1I
  DCD keyscanf2p0c, keyscanf2p0C, keyscanp0c, keyscanp0C
  DCD keyscanf2p0c, keyscanf2p0C, keyscanp0i, keyscanp0I

host_r6502cycle2routines
  DCD keyscanf2p2c, keyscanf2p2C, keyscanp2c, keyscanp2C
  DCD keyscanf2p2c, keyscanf2p2C, keyscanp2i, keyscanp2I
  DCD keyscanf2p1c, keyscanf2p1C, keyscanp1c, keyscanp1C
  DCD keyscanf2p1c, keyscanf2p1C, keyscanp1i, keyscanp1I

host_r6502cycle0s2
  TICK2SCAN1BRANCH 0,host_r6502cycle0s2routines,host_r6502cyclesplit0s1and0s1

host_r6502cycle1s1
  TICK2SCAN1BRANCH 1,host_r6502cycle1s1routines,host_r6502cyclesplit1and0s1

host_r6502cycle2
  TICK2SCAN1BRANCH 2,host_r6502cycle2routines,host_r6502cyclesplit1and1

host_r6502cycle1s2routines
  DCD keyscanf3p1cp0c, keyscanf3p1Cp0C, keyscanf1p1c, keyscanf1p1C
  DCD keyscanf3p1cp0c, keyscanf3p1Cp0C, keyscanf1p1i, keyscanf1p1I
  DCD keyscanf3p0c, keyscanf3p0C, keyscanb1p0c, keyscanb1p0C
  DCD keyscanf3p0c, keyscanf3p0C, keyscanb1p0i, keyscanb1p0I

host_r6502cycle2s1routines
  DCD keyscanf3p2cp0c, keyscanf3p2Cp0C, keyscanf1p2c, keyscanf1p2C
  DCD keyscanf3p2cp0c, keyscanf3p2Cp0C, keyscanf1p2i, keyscanf1p2I
  DCD keyscanf3p1c, keyscanf3p1C, keyscanb1p1c, keyscanb1p1C
  DCD keyscanf3p1c, keyscanf3p1C, keyscanb1p1i, keyscanb1p1I

host_r6502cycle3routines
  DCD keyscanf3p3cp1c, keyscanf3p3Cp1C, keyscanf1p3c, keyscanf1p3C
  DCD keyscanf3p3cp1c, keyscanf3p3Cp1C, keyscanf1p3i, keyscanf1p3I
  DCD keyscanf3p2c, keyscanf3p2C, keyscanb1p2c, keyscanb1p2C
  DCD keyscanf3p2c, keyscanf3p2C, keyscanb1p2i, keyscanb1p2I

host_r6502cycle1s2
  TICKNSCANMULTIPLEBRANCH 3,1,host_r6502cycle1s2routines,secondadvancetimersreturn
  DCD host_r6502cyclesplit1and0s2
  DCD host_r6502cyclesplit1s1and0s1
  TICKNSCANMULTIPLEENDOFTABLE

host_r6502cycle2s1
  TICKNSCANMULTIPLEBRANCH 3,2,host_r6502cycle2s1routines,secondadvancetimersreturn
  DCD host_r6502cyclesplit1and1s1
  DCD host_r6502cyclesplit2and0s1
  TICKNSCANMULTIPLEENDOFTABLE

host_r6502cycle3
  TICKNSCANMULTIPLEBRANCH 3,3,host_r6502cycle3routines,secondadvancetimersreturn
  DCD host_r6502cyclesplit1and2
  DCD host_r6502cyclesplit2and1
  TICKNSCANMULTIPLEENDOFTABLE

secondadvancetimersreturn
  LDR lr, [sp], #4
  B hostadvancetimers

host_r6502cycle2s2routines
  DCD keyscanf4p2cp0c, keyscanf4p2Cp0C, keyscanp2c, keyscanp2C
  DCD keyscanf4p2cp0c, keyscanf4p2Cp0C, keyscanp2i, keyscanp2I
  DCD keyscanf4p1cp0c, keyscanf4p1Cp0C, keyscanp1c, keyscanp1C
  DCD keyscanf4p1cp0c, keyscanf4p1Cp0C, keyscanp1i, keyscanp1I

host_r6502cycle3s1routines
  DCD keyscanf4p3cp1c, keyscanf4p3Cp1C, keyscanp3c, keyscanp3C
  DCD keyscanf4p3cp1c, keyscanf4p3Cp1C, keyscanp3i, keyscanp3I
  DCD keyscanf4p2cp0c, keyscanf4p2Cp0C, keyscanp2c, keyscanp2C
  DCD keyscanf4p2cp0c, keyscanf4p2Cp0C, keyscanp2i, keyscanp2I

host_r6502cycle4routines
  DCD keyscanf4p4cp2c, keyscanf4p4Cp2C, keyscanp4c, keyscanp4C
  DCD keyscanf4p4cp2c, keyscanf4p4Cp2C, keyscanp4i, keyscanp4I
  DCD keyscanf4p3cp1c, keyscanf4p3Cp1C, keyscanp3c, keyscanp3C
  DCD keyscanf4p3cp1c, keyscanf4p3Cp1C, keyscanp3i, keyscanp3I

host_r6502cycle2s2
  TICKNSCANMULTIPLEBRANCH 4,2,host_r6502cycle2s2routines,secondadvancetimersreturn
  DCD host_r6502cyclesplit1and1s2
  DCD host_r6502cyclesplit2and0s2
  DCD host_r6502cyclesplit2s1and0s1
  TICKNSCANMULTIPLEENDOFTABLE

host_r6502cycle3s1
  TICKNSCANMULTIPLEBRANCH 4,3,host_r6502cycle3s1routines,secondadvancetimersreturn
  DCD host_r6502cyclesplit1and2s1
  DCD host_r6502cyclesplit2and1s1
  DCD host_r6502cyclesplit3and0s1
  TICKNSCANMULTIPLEENDOFTABLE

host_r6502cycle4
  TICKNSCANMULTIPLEBRANCH 4,4,host_r6502cycle4routines,secondadvancetimersreturn
  DCD host_r6502cyclesplit1and3
  DCD host_r6502cyclesplit2and2
  DCD host_r6502cyclesplit3and1
  TICKNSCANMULTIPLEENDOFTABLE

host_r6502cycle3s2routines
  DCD keyscanf5p3cp1cp0c, keyscanf5p3Cp1Cp0C, keyscanf1p3c, keyscanf1p3C
  DCD keyscanf5p3cp1cp0c, keyscanf5p3Cp1Cp0C, keyscanf1p3i, keyscanf1p3I
  DCD keyscanf5p2cp0c, keyscanf5p2Cp0C, keyscanb1p2c, keyscanb1p2C
  DCD keyscanf5p2cp0c, keyscanf5p2Cp0C, keyscanb1p2i, keyscanb1p2I

host_r6502cycle4s1routines
  DCD keyscanf5p4cp2cp0c, keyscanf5p4Cp2Cp0C, keyscanf1p4c, keyscanf1p4C
  DCD keyscanf5p4cp2cp0c, keyscanf5p4Cp2Cp0C, keyscanf1p4i, keyscanf1p4I
  DCD keyscanf5p3cp1c, keyscanf5p3Cp1C, keyscanb1p3c, keyscanb1p3C
  DCD keyscanf5p3cp1c, keyscanf5p3Cp1C, keyscanb1p3i, keyscanb1p3I

host_r6502cycle5routines
  DCD keyscanf5p5cp3cp1c, keyscanf5p5Cp3Cp1C, keyscanf1p5c, keyscanf1p5C
  DCD keyscanf5p5cp3cp1c, keyscanf5p5Cp3Cp1C, keyscanf1p5i, keyscanf1p5I
  DCD keyscanf5p4cp2c, keyscanf5p4Cp2C, keyscanb1p4c, keyscanb1p4C
  DCD keyscanf5p4cp2c, keyscanf5p4Cp2C, keyscanb1p4i, keyscanb1p4I

host_r6502cycle3s2
  TICKNSCANMULTIPLEBRANCH 5,3,host_r6502cycle3s2routines,thirdadvancetimersreturn
  DCD host_r6502cyclesplit1and2s2
  DCD host_r6502cyclesplit2and1s2
  DCD host_r6502cyclesplit3and0s2
  DCD host_r6502cyclesplit3s1and0s1
  TICKNSCANMULTIPLEENDOFTABLE

host_r6502cycle4s1
  TICKNSCANMULTIPLEBRANCH 5,4,host_r6502cycle4s1routines,thirdadvancetimersreturn
  DCD host_r6502cyclesplit1and3s1
  DCD host_r6502cyclesplit2and2s1
  DCD host_r6502cyclesplit3and1s1
  DCD host_r6502cyclesplit4and0s1
  TICKNSCANMULTIPLEENDOFTABLE

host_r6502cycle5
  TICKNSCANMULTIPLEBRANCH 5,5,host_r6502cycle5routines,thirdadvancetimersreturn
  DCD host_r6502cyclesplit1and4
  DCD host_r6502cyclesplit2and3
  DCD host_r6502cyclesplit3and2
  DCD host_r6502cyclesplit4and1
  TICKNSCANMULTIPLEENDOFTABLE

thirdadvancetimersreturn
  LDR lr, [sp], #4
  B hostadvancetimers

host_r6502cycle4s2routines
  DCD keyscanf6p4cp2cp0c, keyscanf6p4Cp2Cp0C, keyscanp4c, keyscanp4C
  DCD keyscanf6p4cp2cp0c, keyscanf6p4Cp2Cp0C, keyscanp4i, keyscanp4I
  DCD keyscanf6p3cp1cp0c, keyscanf6p3Cp1Cp0C, keyscanp3c, keyscanp3C
  DCD keyscanf6p3cp1cp0c, keyscanf6p3Cp1Cp0C, keyscanp3i, keyscanp3I

host_r6502cycle5s1routines
  DCD keyscanf6p5cp3cp1c, keyscanf6p5Cp3Cp1C, keyscanp5c, keyscanp5C
  DCD keyscanf6p5cp3cp1c, keyscanf6p5Cp3Cp1C, keyscanp5i, keyscanp5I
  DCD keyscanf6p4cp2cp0c, keyscanf6p4Cp2Cp0C, keyscanp4c, keyscanp4C
  DCD keyscanf6p4cp2cp0c, keyscanf6p4Cp2Cp0C, keyscanp4i, keyscanp4I

host_r6502cycle6routines
  DCD keyscanf6p6cp4cp2c, keyscanf6p6Cp4Cp2C, keyscanp6c, keyscanp6C
  DCD keyscanf6p6cp4cp2c, keyscanf6p6Cp4Cp2C, keyscanp6i, keyscanp6I
  DCD keyscanf6p5cp3cp1c, keyscanf6p5Cp3Cp1C, keyscanp5c, keyscanp5C
  DCD keyscanf6p5cp3cp1c, keyscanf6p5Cp3Cp1C, keyscanp5i, keyscanp5I

host_r6502cycle4s2
  TICKNSCANMULTIPLEBRANCH 6,4,host_r6502cycle4s2routines,thirdadvancetimersreturn
  DCD host_r6502cyclesplit1and3s2
  DCD host_r6502cyclesplit2and2s2
  DCD host_r6502cyclesplit3and1s2
  DCD host_r6502cyclesplit4and0s2
  DCD host_r6502cyclesplit4s1and0s1
  TICKNSCANMULTIPLEENDOFTABLE

host_r6502cycle5s1
  TICKNSCANMULTIPLEBRANCH 6,5,host_r6502cycle5s1routines,thirdadvancetimersreturn
  DCD host_r6502cyclesplit1and4s1
  DCD host_r6502cyclesplit2and3s1
  DCD host_r6502cyclesplit3and2s1
  DCD host_r6502cyclesplit4and1s1
  DCD host_r6502cyclesplit5and0s1
  TICKNSCANMULTIPLEENDOFTABLE

host_r6502cycle6
  TICKNSCANMULTIPLEBRANCH 6,6,host_r6502cycle6routines,thirdadvancetimersreturn
  DCD host_r6502cyclesplit1and5
  DCD host_r6502cyclesplit2and4
  DCD host_r6502cyclesplit3and3
  DCD host_r6502cyclesplit4and2
  DCD host_r6502cyclesplit5and1
  TICKNSCANMULTIPLEENDOFTABLE

host_r6502cycle5s2routines
  DCD keyscanf7p5cp3cp1cp0c, keyscanf7p5Cp3Cp1Cp0C, keyscanf1p5c, keyscanf1p5C
  DCD keyscanf7p5cp3cp1cp0c, keyscanf7p5Cp3Cp1Cp0C, keyscanf1p5i, keyscanf1p5I
  DCD keyscanf7p4cp2cp0c, keyscanf7p4Cp2Cp0C, keyscanb1p4c, keyscanb1p4C
  DCD keyscanf7p4cp2cp0c, keyscanf7p4Cp2Cp0C, keyscanb1p4i, keyscanb1p4I

host_r6502cycle6s1routines
  DCD keyscanf7p6cp4cp2cp0c, keyscanf7p6Cp4Cp2Cp0C, keyscanf1p6c, keyscanf1p6C
  DCD keyscanf7p6cp4cp2cp0c, keyscanf7p6Cp4Cp2Cp0C, keyscanf1p6i, keyscanf1p6I
  DCD keyscanf7p5cp3cp1c, keyscanf7p5Cp3Cp1C, keyscanb1p5c, keyscanb1p5C
  DCD keyscanf7p5cp3cp1c, keyscanf7p5Cp3Cp1C, keyscanb1p5i, keyscanb1p5I

host_r6502cycle5s2
  TICKNSCANMULTIPLEBRANCH 7,5,host_r6502cycle5s2routines,fourthadvancetimersreturn
  DCD host_r6502cyclesplit1and4s2
  DCD host_r6502cyclesplit2and3s2
  DCD host_r6502cyclesplit3and2s2
  DCD host_r6502cyclesplit4and1s2
  DCD host_r6502cyclesplit5and0s2
  DCD host_r6502cyclesplit5s1and0s1
  TICKNSCANMULTIPLEENDOFTABLE

host_r6502cycle6s1
  TICKNSCANMULTIPLEBRANCH 7,6,host_r6502cycle6s1routines,fourthadvancetimersreturn
  DCD host_r6502cyclesplit1and5s1
  DCD host_r6502cyclesplit2and4s1
  DCD host_r6502cyclesplit3and3s1
  DCD host_r6502cyclesplit4and2s1
  DCD host_r6502cyclesplit5and1s1
  DCD host_r6502cyclesplit6and0s1
  TICKNSCANMULTIPLEENDOFTABLE

fourthadvancetimersreturn
  LDR lr, [sp], #4
  B hostadvancetimers

host_r6502cycle6s2routines
  DCD keyscanf8p6cp4cp2cp0c, keyscanf8p6Cp4Cp2Cp0C, keyscanp6c, keyscanp6C
  DCD keyscanf8p6cp4cp2cp0c, keyscanf8p6Cp4Cp2Cp0C, keyscanp6i, keyscanp6I
  DCD keyscanf8p5cp3cp1cp0c, keyscanf8p5Cp3Cp1Cp0C, keyscanp5c, keyscanp5C
  DCD keyscanf8p5cp3cp1cp0c, keyscanf8p5Cp3Cp1Cp0C, keyscanp5i, keyscanp5I

host_r6502cycle6s2
  TICKNSCANMULTIPLEBRANCH 8,6,host_r6502cycle6s2routines,fourthadvancetimersreturn
  DCD host_r6502cyclesplit1and5s2
  DCD host_r6502cyclesplit2and4s2
  DCD host_r6502cyclesplit3and3s2
  DCD host_r6502cyclesplit4and2s2
  DCD host_r6502cyclesplit5and1s2
  DCD host_r6502cyclesplit6and0s2
  DCD host_r6502cyclesplit6s1and0s1
  TICKNSCANMULTIPLEENDOFTABLE

host_r6502cyclesplit0s1and0s1
  CYCLESPLIT host_r6502cycle0s1,host_r6502cycle0s1

host_r6502cyclesplit1and0s1
  CYCLESPLIT host_r6502cycle1,host_r6502cycle0s1

host_r6502cyclesplit1and1
  CYCLESPLIT host_r6502cycle1,host_r6502cycle1

host_r6502cyclesplit1and0s2
  CYCLESPLIT host_r6502cycle1,host_r6502cycle0s2

host_r6502cyclesplit1s1and0s1
  CYCLESPLIT host_r6502cycle1s1,host_r6502cycle0s1

host_r6502cyclesplit1and1s1
  CYCLESPLIT host_r6502cycle1,host_r6502cycle1s1

host_r6502cyclesplit2and0s1
  CYCLESPLIT host_r6502cycle2,host_r6502cycle0s1

host_r6502cyclesplit1and2
  CYCLESPLIT host_r6502cycle1,host_r6502cycle2

host_r6502cyclesplit2and1
  CYCLESPLIT host_r6502cycle2,host_r6502cycle1

host_r6502cyclesplit1and1s2
  CYCLESPLIT host_r6502cycle1,host_r6502cycle1s2

host_r6502cyclesplit2and0s2
  CYCLESPLIT host_r6502cycle2,host_r6502cycle0s2

host_r6502cyclesplit2s1and0s1
  CYCLESPLIT host_r6502cycle2s1,host_r6502cycle0s1

host_r6502cyclesplit1and2s1
  CYCLESPLIT host_r6502cycle1,host_r6502cycle2s1

host_r6502cyclesplit2and1s1
  CYCLESPLIT host_r6502cycle2,host_r6502cycle1s1

host_r6502cyclesplit3and0s1
  CYCLESPLIT host_r6502cycle3,host_r6502cycle0s1

host_r6502cyclesplit1and3
  CYCLESPLIT host_r6502cycle1,host_r6502cycle3

host_r6502cyclesplit2and2
  CYCLESPLIT host_r6502cycle2,host_r6502cycle2

host_r6502cyclesplit3and1
  CYCLESPLIT host_r6502cycle3,host_r6502cycle1

host_r6502cyclesplit1and2s2
  CYCLESPLIT host_r6502cycle1,host_r6502cycle2s2

host_r6502cyclesplit2and1s2
  CYCLESPLIT host_r6502cycle2,host_r6502cycle1s2

host_r6502cyclesplit3and0s2
  CYCLESPLIT host_r6502cycle3,host_r6502cycle0s2

host_r6502cyclesplit3s1and0s1
  CYCLESPLIT host_r6502cycle3s1,host_r6502cycle0s1

host_r6502cyclesplit1and3s1
  CYCLESPLIT host_r6502cycle1,host_r6502cycle3s1

host_r6502cyclesplit2and2s1
  CYCLESPLIT host_r6502cycle2,host_r6502cycle2s1

host_r6502cyclesplit3and1s1
  CYCLESPLIT host_r6502cycle3,host_r6502cycle1s1

host_r6502cyclesplit4and0s1
  CYCLESPLIT host_r6502cycle4,host_r6502cycle0s1

host_r6502cyclesplit1and4
  CYCLESPLIT host_r6502cycle1,host_r6502cycle4

host_r6502cyclesplit2and3
  CYCLESPLIT host_r6502cycle2,host_r6502cycle3

host_r6502cyclesplit3and2
  CYCLESPLIT host_r6502cycle3,host_r6502cycle2

host_r6502cyclesplit4and1
  CYCLESPLIT host_r6502cycle4,host_r6502cycle1

host_r6502cyclesplit1and3s2
  CYCLESPLIT host_r6502cycle1,host_r6502cycle3s2

host_r6502cyclesplit2and2s2
  CYCLESPLIT host_r6502cycle2,host_r6502cycle2s2

host_r6502cyclesplit3and1s2
  CYCLESPLIT host_r6502cycle3,host_r6502cycle1s2

host_r6502cyclesplit4and0s2
  CYCLESPLIT host_r6502cycle4,host_r6502cycle0s2

host_r6502cyclesplit4s1and0s1
  CYCLESPLIT host_r6502cycle4s1,host_r6502cycle0s1

host_r6502cyclesplit1and4s1
  CYCLESPLIT host_r6502cycle1,host_r6502cycle4s1

host_r6502cyclesplit2and3s1
  CYCLESPLIT host_r6502cycle2,host_r6502cycle3s1

host_r6502cyclesplit3and2s1
  CYCLESPLIT host_r6502cycle3,host_r6502cycle2s1

host_r6502cyclesplit4and1s1
  CYCLESPLIT host_r6502cycle4,host_r6502cycle1s1

host_r6502cyclesplit5and0s1
  CYCLESPLIT host_r6502cycle5,host_r6502cycle0s1

host_r6502cyclesplit1and5
  CYCLESPLIT host_r6502cycle1,host_r6502cycle5

host_r6502cyclesplit2and4
  CYCLESPLIT host_r6502cycle2,host_r6502cycle4

host_r6502cyclesplit3and3
  CYCLESPLIT host_r6502cycle3,host_r6502cycle3

host_r6502cyclesplit4and2
  CYCLESPLIT host_r6502cycle4,host_r6502cycle2

host_r6502cyclesplit5and1
  CYCLESPLIT host_r6502cycle5,host_r6502cycle1

host_r6502cyclesplit1and4s2
  CYCLESPLIT host_r6502cycle1,host_r6502cycle4s2

host_r6502cyclesplit2and3s2
  CYCLESPLIT host_r6502cycle2,host_r6502cycle3s2

host_r6502cyclesplit3and2s2
  CYCLESPLIT host_r6502cycle3,host_r6502cycle2s2

host_r6502cyclesplit4and1s2
  CYCLESPLIT host_r6502cycle4,host_r6502cycle1s2

host_r6502cyclesplit5and0s2
  CYCLESPLIT host_r6502cycle5,host_r6502cycle0s2

host_r6502cyclesplit5s1and0s1
  CYCLESPLIT host_r6502cycle5s1,host_r6502cycle0s1

host_r6502cyclesplit1and5s1
  CYCLESPLIT host_r6502cycle1,host_r6502cycle5s1

host_r6502cyclesplit2and4s1
  CYCLESPLIT host_r6502cycle2,host_r6502cycle4s1

host_r6502cyclesplit3and3s1
  CYCLESPLIT host_r6502cycle3,host_r6502cycle3s1

host_r6502cyclesplit4and2s1
  CYCLESPLIT host_r6502cycle4,host_r6502cycle2s1

host_r6502cyclesplit5and1s1
  CYCLESPLIT host_r6502cycle5,host_r6502cycle1s1

host_r6502cyclesplit6and0s1
  CYCLESPLIT host_r6502cycle6,host_r6502cycle0s1

host_r6502cyclesplit1and5s2
  CYCLESPLIT host_r6502cycle1,host_r6502cycle5s2

host_r6502cyclesplit2and4s2
  CYCLESPLIT host_r6502cycle2,host_r6502cycle4s2

host_r6502cyclesplit3and3s2
  CYCLESPLIT host_r6502cycle3,host_r6502cycle3s2

host_r6502cyclesplit4and2s2
  CYCLESPLIT host_r6502cycle4,host_r6502cycle2s2

host_r6502cyclesplit5and1s2
  CYCLESPLIT host_r6502cycle5,host_r6502cycle1s2

host_r6502cyclesplit6and0s2
  CYCLESPLIT host_r6502cycle6,host_r6502cycle0s2

host_r6502cyclesplit6s1and0s1
  CYCLESPLIT host_r6502cycle6s1,host_r6502cycle0s1

|host_r6502readspecial|
  SUB r3,r0,#(&FC00:SHL:2)-:INDEX:HOST_SPECIALREADOPS
  LDR pc,[r3,r1,LSR #14]

|host_r6502writespecial|
  SUB r3,r0,#(&FC00:SHL:2)-:INDEX:HOST_SPECIALWRITEOPS
  LDR pc,[r3,r1,LSR #14]

|hostadvancetimers|
  STMFD sp!,{r4-r5,lr}

  MOV r1,#0
  LDR r4,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_ORIGINAL]
  STR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_ORIGINAL]
  TST r4,#1
  LDRNE r2,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_ODD]
  EORNE r2,r2,#1
  STRNE r2,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_ODD]
  LDR r2,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_MONOTONIC]
  ADD r2,r2,r4
  STR r2,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_MONOTONIC]
  MOV r5,#0x10000

  LDR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_SYSVIATOGO]
  SUBS r1,r1,r4
  BMI advancetimers2
  STR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_SYSVIATOGO]
  ADDNE pc,pc,#8-4
  BL systemviaatzerocycles
  LDR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_SYSVIATOGO]
  SUB r2,r1,#1
  CMP r2,r5
  MOVLO r5,r1

advancetimers2
  LDR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_USRVIATOGO]
  SUBS r1,r1,r4
  BMI advancetimers3
  STR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_USRVIATOGO]
  ADDNE pc,pc,#8-4
  BL userviaatzerocycles
  LDR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_USRVIATOGO]
  SUB r2,r1,#1
  CMP r2,r5
  MOVLO r5,r1

advancetimers3
  LDR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_I8271TOGO]
  SUBS r1,r1,r4
  BMI advancetimers4
  STR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_I8271TOGO]
  ADDNE pc,pc,#8-4
  BL i8271poll
  LDR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_I8271TOGO]
  SUB r2,r1,#1
  CMP r2,r5
  MOVLO r5,r1

advancetimers4
  LDR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_W1770TOGO]
  SUBS r1,r1,r4
  BMI advancetimers5
  STR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_W1770TOGO]
  ADDNE pc,pc,#8-4
  BL w1770poll
  LDR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_W1770TOGO]
  SUB r2,r1,#1
  CMP r2,r5
  MOVLO r5,r1

advancetimers5
  LDR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_ADCTOGO]
  SUBS r1,r1,r4
  BMI advancetimers6
  STR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_ADCTOGO]
  ADDNE pc,pc,#8-4
  BL adcpoll
  LDR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_ADCTOGO]
  SUB r2,r1,#1
  CMP r2,r5
  MOVLO r5,r1

advancetimers6
  LDR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_M6850TOGO]
  SUBS r1,r1,r4
  BMI advancetimers7
  STR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_M6850TOGO]
  ADDNE pc,pc,#8-4
  BL aciapoll
  LDR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_M6850TOGO]
  SUB r2,r1,#1
  CMP r2,r5
  MOVLO r5,r1

advancetimers7
  LDR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_VIDEOTOGO]
  SUBS r1,r1,r4
  BMI advancetimers8
  STR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_VIDEOTOGO]
  ADDNE pc,pc,#8-4
  BL videoatzerocycles
  LDR r1,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_VIDEOTOGO]
  SUB r2,r1,#1
  CMP r2,r5
  MOVLO r5,r1

advancetimers8
  STR r5,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_ORIGINAL]
  STR r5,[r0,#:INDEX:HOST_CYCLES+:INDEX:HOSTCYCLES_TOGO]
  LDMFD sp!,{r4-r5,pc}

|hostexecute|
  LDR r0,=hostmap
  R6502_EXECUTE_PUSH
  LDR r1,[r0,#:INDEX:R6502_EXECUTE_CPU_STATE]
  MOV r3,#R6502_REGULAR_TRANSITION
  STR r1,[r0,#:INDEX:R6502_CPU_STATE]
  STR r3,[r0,#:INDEX:R6502_TRANSITION1]
  STR r3,[r0,#:INDEX:R6502_TRANSITION2]
  [ Optimise6502Links
  ADR r2,hostexecute1
  ADR r3,hostexecute2
  STR r2,[r0,#:INDEX:R6502_CONTINUELINK]
  STR r3,[r0,#:INDEX:R6502_YIELDLINK]
  ]
hostexecute1
  [ Optimise6502Links
  LDR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR pc, [r1], #4
  |
  ADD r3,r0,#:INDEX:R6502_SEQUENCES
  LDR r1,[r0,#:INDEX:R6502_CPU_STATE]
  LDR r2,[r3,#R6502_YIELD_SEQUENCE:SHL:2]
  CMP r1,r2
  ADR lr,hostexecute1
  LDRNE pc, [r1], #4
  ]
hostexecute2
  R6502_EXECUTE_POP

;Data Area

  AREA    |C$$bss|, NOINIT

|hostmap|
  % SIZEOF_HOSTMAP

  END
