/*>keyboard.c
 *
 * BeebIt - BBC Micro Model B Emulator
 *
 * (C) Copyright Michael J Foot, 1998-2025
 *
 * Email: <mjfoot.nz@gmail.com>
 *
 * Cycle-level keyboard emulation contributed by Crispian Daniels in 2025
 *
 * Email: <convertedgames@3insdale.me.uk>
 */

#include <string.h>
#include "beebit.h"
#include "host.h"
#include "6522sysvia.h"
#include "kernel.h"
#include "riscos.h"
#include "6522sysvia.h"
#include "keyboard.h"

extern void keyboardload(char *filename);

void keyboardreset(void)
{
  char cbuffer[128];
  strcpy(cbuffer,"<BeebIt$Dir>.KeyMaps.");
  strcat(cbuffer,beebit_keylayout);
  keyboardload(cbuffer);
}

void keyboardload(char *filename)
{
  FILE * hfile;
  hfile = fopen(filename,"rb");
  if (hfile != NULL)
  {
    fread(&keylookup,1,0x100,hfile);
    fclose(hfile);
  }
}

void keyboardsetlinks(void)
{
  HOSTMAP* hmap = &hostmap;
  int i;
  switch (beebit_machinetype)
  {
    case MACHINE_MODELB:
    case MACHINE_MODELBPLUS:
      for (i=0;i<8;i++)
      {
        if (beebit_links & (1 << (7-i)))
          hmap->keystatus[0x02+i] |= 1;
        else
          hmap->keystatus[0x02+i] &= 0xFE;
      }
      break;
    case MACHINE_MASTER128:
    case MACHINE_COMPACT:
      for (i=0;i<8;i++)
        hmap->keystatus[0x02+i] &= 0xFE;
      break;
  }
}
